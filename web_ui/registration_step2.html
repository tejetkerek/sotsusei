<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海外レシート管理マスター - ステップ2/3：確認&修正 v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#3B82F6',
                        'custom-gray': '#6B7280'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-base-100 min-h-screen">
    <div class="min-h-screen bg-gray-100">
        <div class="w-full bg-white min-h-screen">
            <!-- ナビゲーションヘッダー（動的に生成される） -->
            
            <div class="px-3 py-4 sm:px-4 sm:py-6 pt-16 pb-16">
            <!-- ヘッダー -->
            <div class="text-center mb-6">
            </div>

            <!-- デバッグボタン（固定位置） -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <h3 class="text-sm font-medium text-yellow-800 mb-2">デバッグツール</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="debugLocalStorage()" class="btn btn-xs btn-outline">デバッグ: localStorage確認</button>
                    <button onclick="loadReceiptFromLocalStorage()" class="btn btn-xs btn-outline">手動読み込み</button>
                    <button onclick="setTestData()" class="btn btn-xs btn-outline">テストデータ設定</button>
                    <button onclick="clearLocalStorage()" class="btn btn-xs btn-outline">localStorageクリア</button>
                </div>
            </div>
            
            <!-- 現在のレシート -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="p-4" id="receiptContent">
                    <!-- 現在のレシート -->
                    <div class="border border-gray-200 rounded-lg p-3 mb-4">
                        
                        <!-- レシート情報表示 -->
                        <div class="space-y-2" id="receiptInfo">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">店舗名:</span>
                                <span class="font-medium text-gray-800">読み込み中...</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">日付:</span>
                                <span class="font-medium text-gray-800">読み込み中...</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">金額:</span>
                                <span class="font-medium text-gray-800">読み込み中...</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">日本円換算:</span>
                                <span class="font-medium text-blue-600">読み込み中...</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">場所:</span>
                                <span class="font-medium text-gray-800">読み込み中...</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">カテゴリ:</span>
                                <select class="select select-bordered select-xs border-gray-300 w-20 text-xs">
                                    <option value="food">食費</option>
                                    <option value="transport">交通費</option>
                                    <option value="shopping">お買い物</option>
                                    <option value="entertainment">娯楽</option>
                                    <option value="accommodation">宿泊費</option>
                                    <option value="other">その他</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- メインアクションボタン（ロケーションの下に表示） -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
            <div class="grid grid-cols-2 gap-3">
                <!-- 修正ボタン -->
                <button onclick="openEditModal()" class="btn bg-slate-600 hover:bg-slate-700 text-white text-xs px-2 py-2 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span class="whitespace-nowrap text-xs leading-tight">内容を修正する</span>
                </button>
                
                <!-- 承認ボタン -->
                <button onclick="handleConfirmation()" class="btn bg-amber-600 hover:bg-amber-700 text-white text-xs px-2 py-2 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="whitespace-nowrap text-xs leading-tight">承認して登録する</span>
                </button>
            </div>
        </div>

        <!-- サマリ情報を見るボタン -->
        <div class="text-center mb-4">
            <a href="registration_step3.html" class="btn btn-outline btn-sm">
                サマリ情報を見る
            </a>
        </div>
            </div>
            </div>
        </div>
    </div>


    <!-- 編集モーダル -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800" id="editModalTitle">項目を編集</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2" id="editModalLabel">値</label>
                <div id="editModalInput"></div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeEditModal()" class="btn btn-outline btn-sm">キャンセル</button>
                <button onclick="saveEdit()" class="btn bg-slate-600 hover:bg-slate-700 text-white btn-sm">保存</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <!-- Navigation -->
    <script src="navigation.js"></script>
    
    <script type="module">
        // Firebase関数を動的にインポート
        let firebaseFunctions = null;
        let currentReceipts = [];
        let currentIndex = 0;
        
        // Firebase関数を読み込み
        async function loadFirebaseFunctions() {
            try {
                console.log('Firebaseモジュールを読み込み中... (v2.1)');
                
                // ローディング表示を更新
                const content = document.getElementById('receiptContent');
                if (!content) {
                    console.error('receiptContent要素が見つかりません');
                    return;
                }
                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="loading loading-spinner loading-lg text-blue-600 mb-4"></div>
                        <p class="text-gray-600">Firebase関数を読み込み中...</p>
                        <p class="text-xs text-gray-500 mt-2">データベース接続を確立しています</p>
                    </div>
                `;
                
                // モジュールを読み込み
                const firebaseModule = await import('./firebase-config.js');
                console.log('Firebaseモジュール:', firebaseModule);
                console.log('モジュールのキー:', Object.keys(firebaseModule));
                
                // 認証状態を確認（firebase-config.jsの認証状態を信頼）
                if (firebaseModule.auth) {
                    const user = firebaseModule.auth.currentUser;
                    console.log('現在のユーザー:', user);
                    
                    if (!user) {
                        console.log('ユーザーがログインしていません。firebase-config.jsの認証状態を待機します...');
                        // 認証状態の変化を待機
                        await new Promise((resolve) => {
                            const unsubscribe = firebaseModule.auth.onAuthStateChanged((user) => {
                                unsubscribe();
                                console.log('認証状態変化を検出:', user?.email || 'ログアウト');
                                resolve();
                            });
                        });
                    } else {
                        console.log('ユーザーは既にログインしています:', user.uid);
                    }
                }
                
                // 各関数の存在確認
                console.log('saveReceiptFromJSON:', firebaseModule.saveReceiptFromJSON);
                console.log('auth:', firebaseModule.auth);
                
                // 関数の存在確認
                if (!firebaseModule.saveReceiptFromJSON) {
                    console.error('saveReceiptFromJSON関数が見つかりません');
                    console.log('利用可能な関数:', Object.keys(firebaseModule));
                    showErrorMessage('saveReceiptFromJSON関数が見つかりません');
                    return;
                }
                
                // 関数を直接使用する方法に変更
                firebaseFunctions = {
                    saveReceiptFromJSON: firebaseModule.saveReceiptFromJSON,
                    auth: firebaseModule.auth
                };
                
                console.log('Firebase関数の読み込み完了:', firebaseFunctions);
                console.log('saveReceiptFromJSON関数の型:', typeof firebaseFunctions.saveReceiptFromJSON);
                
                // ユーザー情報を更新
                updateUserInfo();
                
                // 利用可能な関数を確認
                if (firebaseModule.getAvailableFunctions) {
                    const availableFunctions = firebaseModule.getAvailableFunctions();
                    console.log('利用可能な関数:', availableFunctions);
                }
            } catch (error) {
                console.error('Firebase関数の読み込みエラー:', error);
                showErrorMessage('Firebase関数の読み込みに失敗しました: ' + error.message);
            }
        }
        
        // ページ読み込み時にFirebase関数を読み込み
        loadFirebaseFunctions();
        
        
        // レシート表示を更新
        function updateReceiptDisplay() {
            if (currentReceipts.length === 0) return;
            
            const receipt = currentReceipts[currentIndex];
            console.log('レシート表示更新:', receipt);
            console.log('レシート画像URL:', receipt.imageUrl);
            console.log('レシートの全プロパティ:', Object.keys(receipt));
            
            // 画像URLの詳細確認
            if (receipt.imageUrl) {
                console.log('画像URLが存在:', receipt.imageUrl);
            } else {
                console.log('画像URLが存在しません');
                // 代替の画像URLプロパティを確認
                console.log('代替プロパティ確認:');
                console.log('- image_url:', receipt.image_url);
                console.log('- imageUrl:', receipt.imageUrl);
                console.log('- image:', receipt.image);
            }
            
            // ローディング表示を確実にクリア
            const content = document.getElementById('receiptContent');
            if (content) {
                content.innerHTML = ''; // 既存の内容をクリア
                console.log('receiptContentをクリアしました');
            }
            
            
            
            // レシート情報を更新（HTMLの構造に合わせて修正）
            const receiptInfoContainer = document.querySelector('.space-y-2');
            if (receiptInfoContainer) {
                console.log('レシート情報コンテナを発見:', receiptInfoContainer);
                
                // 店舗名を更新
                const storeNameElement = receiptInfoContainer.querySelector('span.font-medium.text-gray-800');
                if (storeNameElement) {
                    storeNameElement.textContent = receipt.store?.name || receipt.storeName || '店舗名不明';
                    console.log('店舗名を更新:', storeNameElement.textContent);
                }
                
                // 金額を更新
                const amountElements = receiptInfoContainer.querySelectorAll('span.font-medium.text-gray-800');
                if (amountElements.length > 1) {
                    const amountElement = amountElements[2]; // 金額の要素
                    if (amountElement) {
                        const currency = receipt.transaction?.currency || 'JPY';
                        const amount = receipt.transaction?.amount || 0;
                        amountElement.textContent = `${currency} ${amount}`;
                        console.log('金額を更新:', amountElement.textContent);
                    }
                }
                
                // 日本円換算を更新
                const jpyElement = receiptInfoContainer.querySelector('span.font-medium.text-blue-600');
                if (jpyElement) {
                    const jpyAmount = receipt.transaction?.jpyAmount || 0;
                    jpyElement.textContent = `¥ ${jpyAmount}`;
                    console.log('日本円換算を更新:', jpyElement.textContent);
                }
                
            } else {
                console.error('レシート情報コンテナが見つかりません');
            }
            
            // レシート詳細情報を更新（動的にフィールドを生成）
            const detailsContainer = document.querySelector('.bg-white .space-y-2');
            if (!detailsContainer) {
                // 別のセレクターで探す
                const altDetailsContainer = document.querySelector('.space-y-2');
                if (altDetailsContainer) {
                    console.log('レシート詳細情報のコンテナを代替セレクターで発見:', altDetailsContainer);
                }
            }
            
            const finalDetailsContainer = document.querySelector('.bg-white .space-y-2') || document.querySelector('.space-y-2');
            if (finalDetailsContainer) {
                console.log('レシート詳細情報のコンテナを発見:', finalDetailsContainer);
                console.log('レシートデータ:', receipt);
                
                // 既存の内容をクリア
                finalDetailsContainer.innerHTML = '';
                
                // データのサニタイズ（XSS対策）
                const sanitizeValue = (value) => {
                    if (value === null || value === undefined) return '';
                    return String(value).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                };
                
                // 日付のフォーマット（YYYY-MM-DD形式に変換）
                const formatDate = (dateString) => {
                    try {
                        if (!dateString) return '';
                        
                        // 既にYYYY-MM-DD形式の場合はそのまま返す
                        if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                            return dateString;
                        }
                        
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            console.warn('無効な日付形式:', dateString);
                            return '';
                        }
                        return date.toISOString().split('T')[0];
                    } catch (error) {
                        console.error('日付フォーマットエラー:', error, '入力値:', dateString);
                        return '';
                    }
                };
                
                // 動的にフィールドを生成する関数（テキスト表示 + 編集ボタン）
                const generateFieldHTML = (label, value, fieldType, fieldId) => {
                    let displayValue = '';
                    if (fieldType === 'currency') {
                        const amount = getNestedValue(receipt, 'transaction.amount') || 0;
                        displayValue = `${sanitizeValue(value)} ${amount}`;
                    } else if (fieldType === 'display') {
                        displayValue = `¥ ${sanitizeValue(value)}`;
                    } else {
                        displayValue = sanitizeValue(value);
                    }
                    
                    return `
                        <div class="flex justify-between items-center text-sm group">
                            <span class="text-gray-600">${label}:</span>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-800" id="${fieldId}_display">${displayValue}</span>
                                <button onclick="editField('${fieldId}', '${fieldType}', '${sanitizeValue(value)}')" 
                                        class="btn btn-xs btn-outline opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                };
                
                // レシートデータの項目を動的に生成
                let fieldsHTML = '';
                
                // 基本的なフィールドを順番に生成（新しい構造に対応）
                const fieldConfigs = [
                    { key: 'store.name', label: '店舗名', type: 'text', id: 'storeNameInput' },
                    { key: 'transaction.date', label: '日付', type: 'date', id: 'dateInput' },
                    { key: 'transaction.currency', label: '通貨', type: 'currency', id: 'amountInput' },
                    { key: 'transaction.jpyAmount', label: '日本円換算', type: 'display', id: 'jpyAmountDisplay' },
                    { key: 'store.location', label: '場所', type: 'text', id: 'locationInput' },
                    { key: 'category', label: 'カテゴリ', type: 'select', id: 'categorySelect' }
                ];
                
                // ネストされたプロパティの値を取得する関数
                const getNestedValue = (obj, path) => {
                    return path.split('.').reduce((current, key) => current?.[key], obj);
                };
                
                // 各フィールドを生成
                fieldConfigs.forEach(config => {
                    const value = getNestedValue(receipt, config.key);
                    if (value !== undefined && value !== null && value !== '') {
                        fieldsHTML += generateFieldHTML(config.label, value, config.type, config.id);
                    }
                });
                
                // 追加のフィールド（items、originalText等）がある場合
                if (receipt.items && receipt.items.length > 0) {
                    fieldsHTML += `
                        <div class="flex justify-between items-start text-sm">
                            <span class="text-gray-600">商品:</span>
                            <div class="text-xs text-gray-800 max-w-32">
                                ${receipt.items.map(item => {
                                    const name = item.name || item.item || item;
                                    const price = item.price || item.amount || '0';
                                    return `${sanitizeValue(name)}: ¥${sanitizeValue(price)}`;
                                }).join('<br>')}
                            </div>
                        </div>
                    `;
                }
                
                if (receipt.originalText) {
                    fieldsHTML += `
                        <div class="flex justify-between items-start text-sm">
                            <span class="text-gray-600">元のテキスト:</span>
                            <div class="text-xs text-gray-600 max-w-32 max-h-20 overflow-y-auto">
                                ${sanitizeValue(receipt.originalText).substring(0, 100)}...
                            </div>
                        </div>
                    `;
                }
                
                // 確認ボタンを追加
                fieldsHTML += `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <button onclick="handleConfirmation()" class="btn bg-amber-600 hover:bg-amber-700 text-white btn-sm w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            確認完了 → 次のレシートへ
                        </button>
                    </div>
                `;
                
                finalDetailsContainer.innerHTML = fieldsHTML;
                console.log('動的に生成されたレシート詳細情報:', fieldsHTML);
                
                // 金額変更時の日本円換算を更新
                const amountInput = document.getElementById('amountInput');
                const jpyAmountSpan = document.getElementById('jpyAmountDisplay');
                
                if (amountInput && jpyAmountSpan) {
                    const updateJPYAmount = () => {
                        const currency = receipt.currency || 'JPY';
                        const amount = parseFloat(amountInput.value) || 0;
                        
                        // 簡単な為替レート（実際のアプリではAPIから取得）
                        const exchangeRates = {
                            'JPY': 1,
                            'USD': 150,
                            'EUR': 160,
                            'GBP': 190,
                            'AUD': 100,
                            'CAD': 110,
                            'CHF': 170,
                            'CNY': 20,
                            'KRW': 0.11,
                            'SGD': 110,
                            'THB': 4.2,
                            'MYR': 32,
                            'IDR': 0.01,
                            'PHP': 2.7,
                            'VND': 0.006,
                            'INR': 1.8
                        };
                        
                        const jpyAmount = Math.round(amount * (exchangeRates[currency] || 1));
                        jpyAmountSpan.textContent = `¥ ${jpyAmount}`;
                    };
                    
                    amountInput.addEventListener('input', updateJPYAmount);
                }
            } else {
                console.error('レシート詳細情報のコンテナが見つかりません');
            }
            
            
            // レシート情報をreceiptContentに追加
            if (content) {
                const receiptHTML = `
                    <div class="border border-gray-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-600">現在処理中</span>
                        </div>
                        
                        
                        <!-- レシート情報表示 -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">利用日:</span>
                                <span class="font-medium text-gray-800">${receipt.transaction?.date || receipt.date || '日付不明'}</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">店舗名:</span>
                                <span class="font-medium text-gray-800">${receipt.store?.name || receipt.storeName || '店舗名不明'}</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">商品:</span>
                                <div class="text-xs text-gray-800 max-w-32 text-right">
                                    ${receipt.items ? receipt.items.map(item => {
                                        const name = item.name || item.item || item;
                                        const price = item.price || item.amount || '0';
                                        return `${name}: ¥${price}`;
                                    }).join('<br>') : '商品情報なし'}
                                </div>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">金額合計（元通貨）:</span>
                                <span class="font-medium text-gray-800">${receipt.transaction?.currency || receipt.currency || 'JPY'} ${receipt.transaction?.amount || receipt.totalAmount || 0}</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">金額合計（日本円）:</span>
                                <span class="font-medium text-blue-600">¥ ${receipt.transaction?.jpyAmount || receipt.jpyAmount || 0}</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">カテゴリ:</span>
                                <span class="font-medium text-gray-800">${receipt.category || 'カテゴリ不明'}</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ロケーション:</span>
                                <span class="font-medium text-gray-800">${receipt.store?.location || receipt.location || '場所不明'}</span>
                            </div>
                        </div>
                    </div>
                `;
                content.innerHTML = receiptHTML;
                console.log('レシート情報をreceiptContentに追加しました');
            }
            
            console.log('レシート表示が完了しました');
        }
        
        
        // 進捗情報を更新
        function updateProgressInfo() {
            const processedCount = currentIndex; // 現在のインデックスが処理済み数
            const remainingCount = currentReceipts.length - currentIndex - 1; // 残り数（現在のレシートを除く）
            
            // より具体的なセレクターを使用（左端の開発リストを避ける）
            const progressElement = document.querySelector('.bg-white .flex.justify-between.items-center.mb-4');
            if (progressElement) {
                console.log('進捗情報要素を発見:', progressElement);
                console.log(`進捗情報更新: 処理済み=${processedCount}件, 残り=${remainingCount}件, 総数=${currentReceipts.length}件`);
                progressElement.innerHTML = `
                    <span class="text-sm text-gray-600">処理済み: ${processedCount}件</span>
                    <span class="text-sm text-gray-600">残り: ${remainingCount}件</span>
                `;
                console.log('進捗情報の更新が完了しました');
            } else {
                console.error('進捗情報要素が見つかりません');
            }
        }
        
        // ローディング表示
        function showLoadingMessage(message = 'レシートを読み込み中...') {
            const content = document.getElementById('receiptContent');
            if (!content) {
                console.error('receiptContent要素が見つかりません');
                return;
            }
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading loading-spinner loading-lg text-blue-600 mb-4"></div>
                    <p class="text-gray-600">${message}</p>
                    <p class="text-xs text-gray-500 mt-2">Firebase接続を確認しています</p>
                    <button onclick="location.reload()" class="btn btn-outline btn-sm mt-4">
                        ページをリロード
                    </button>
                </div>
            `;
        }

        // レシートなしメッセージを表示
        function showNoReceiptsMessage() {
            // receiptInfo要素の内容をクリア
            const receiptInfo = document.getElementById('receiptInfo');
            if (receiptInfo) {
                receiptInfo.innerHTML = '';
                console.log('receiptInfo要素の内容をクリアしました');
            }
            
            // より具体的なセレクターを使用（左端の開発リストを避ける）
            const messageContainer = document.querySelector('.bg-white .bg-white.rounded-lg.shadow-sm.border.border-gray-200.mb-4');
            if (messageContainer) {
                console.log('レシートなしメッセージのコンテナを発見:', messageContainer);
                messageContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-800 mb-2">確認待ちのレシートがありません</h3>
                        <p class="text-gray-600 mb-4">レシート登録ページから新しいレシートを追加してください。</p>
                        <button onclick="window.location.href='registration_step1.html'" class="btn bg-slate-600 hover:bg-slate-700 text-white">
                            レシート登録へ
                        </button>
                    </div>
                `;
            } else {
                console.error('レシートなしメッセージのコンテナが見つかりません');
            }
        }
        
        // エラーメッセージを表示
        function showErrorMessage(message) {
            // より具体的なセレクターを使用（左端の開発リストを避ける）
            const errorContainer = document.querySelector('.bg-white .bg-white.rounded-lg.shadow-sm.border.border-gray-200.mb-4');
            if (errorContainer) {
                console.log('エラーメッセージのコンテナを発見:', errorContainer);
                errorContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="text-red-600 mb-4">${message}</div>
                        <button onclick="location.reload()" class="btn btn-outline">再読み込み</button>
                    </div>
                `;
            } else {
                console.error('エラーメッセージのコンテナが見つかりません');
            }
        }
        
        // 承認処理中フラグ
        let isProcessingConfirmation = false;
        
        // 確認完了ボタンの処理
        window.handleConfirmation = async function() {
            // 重複実行を防ぐ
            if (isProcessingConfirmation) {
                console.log('承認処理が既に実行中です');
                return;
            }
            
            isProcessingConfirmation = true;
            console.log('承認処理開始');
            
            try {
                // localStorageから分析結果を取得
                const analysisData = localStorage.getItem('currentReceiptAnalysis');
                if (!analysisData) {
                    alert('分析結果が見つかりません。レシート登録ページからやり直してください。');
                    return;
                }
                
                let receiptData;
                try {
                    receiptData = JSON.parse(analysisData);
                    console.log('承認するレシートデータ:', receiptData);
                } catch (error) {
                    console.error('分析結果の解析エラー:', error);
                    alert('分析結果の解析に失敗しました。');
                    return;
                }
                
                // Firebase関数が読み込まれているかチェック
                console.log('Firebase関数の確認中...');
                console.log('firebaseFunctions:', firebaseFunctions);
                console.log('firebaseFunctions.saveReceiptFromJSON:', firebaseFunctions?.saveReceiptFromJSON);
                
                if (!firebaseFunctions || !firebaseFunctions.saveReceiptFromJSON) {
                    console.error('Firebase関数が読み込まれていません');
                    alert('Firebase関数が読み込まれていません。ページを再読み込みしてください。');
                    return;
                }
                
                console.log('Firebase関数の確認完了');
                // データ構造を確認して適切に変換
                console.log('データ構造の確認中...');
                console.log('receiptDataの構造:', receiptData);
                console.log('receiptData.store:', receiptData.store);
                console.log('receiptData.transaction:', receiptData.transaction);
                console.log('receiptData.extracted_data:', receiptData.extracted_data);
                
                // 修正されたデータがある場合はそれを使用、なければ元のデータを使用
                const finalReceiptData = {
                    receipt_id: receiptData.receipt_id || `receipt_${Date.now()}`,
                    image_url: receiptData.image_url || '',
                    extracted_data: {
                        // 修正されたデータを優先、なければ元のデータを使用
                        storeName: receiptData.store?.name || receiptData.extracted_data?.storeName || '',
                        date: receiptData.transaction?.date || receiptData.date || receiptData.extracted_data?.date || '',
                        currency: receiptData.transaction?.currency || receiptData.currency || receiptData.extracted_data?.currency || 'JPY',
                        totalAmount: receiptData.transaction?.amount || receiptData.totalAmount || receiptData.extracted_data?.totalAmount || 0,
                        jpyAmount: receiptData.jpyAmount || receiptData.extracted_data?.jpyAmount || 0,
                        location: receiptData.store?.location || receiptData.extracted_data?.location || '',
                        category: receiptData.category || receiptData.extracted_data?.category || 'food',
                        items: receiptData.items || receiptData.extracted_data?.items || [],
                        original_text: receiptData.extracted_data?.original_text || '',
                        translated_text: receiptData.extracted_data?.translated_text || '',
                        conversions: receiptData.extracted_data?.conversions || []
                    },
                    processed_at: receiptData.processed_at || new Date().toISOString(),
                    confidence: receiptData.confidence || 0.95
                };
                
                console.log('変換後のレシートデータ:', finalReceiptData);
                console.log('Firebase関数の確認:', firebaseFunctions);
                console.log('saveReceiptFromJSON関数の確認:', firebaseFunctions.saveReceiptFromJSON);
                
                // Firebase Databaseに保存
                console.log('Firebase Databaseに保存中...');
                const saveResult = await firebaseFunctions.saveReceiptFromJSON(finalReceiptData);
                console.log('Firebase Databaseへの保存完了:', saveResult);
                
                // localStorageから削除
                localStorage.removeItem('currentReceiptAnalysis');
                console.log('localStorageから削除完了');
                
                alert('レシートの登録が完了しました！');
                
                // サマリーページに遷移
                setTimeout(() => {
                    window.location.href = 'registration_step3.html';
                }, 2000);
                
            } catch (error) {
                console.error('Firebase Databaseへの保存エラー:', error);
                console.error('エラーの詳細:', error.stack);
                alert('データベースへの保存に失敗しました: ' + error.message);
            } finally {
                // 処理中フラグをリセット
                isProcessingConfirmation = false;
            }
        }
        
        // 編集機能の変数
        let currentEditField = null;
        let currentEditType = null;
        let currentEditValue = null;
        
        // 編集モーダルを開く
        window.openEditModal = function() {
            console.log('修正モーダルを開こうとしています...');
            
            // localStorageから分析結果を取得
            const analysisData = localStorage.getItem('currentReceiptAnalysis');
            if (!analysisData) {
                console.log('localStorageに分析結果がありません');
                alert('分析結果が見つかりません。レシート登録ページからやり直してください。');
                return;
            }
            
            let receipt;
            try {
                receipt = JSON.parse(analysisData);
                console.log('localStorageから読み込んだレシート:', receipt);
            } catch (error) {
                console.error('分析結果の解析エラー:', error);
                alert('分析結果の解析に失敗しました。');
                return;
            }
            
            // モーダル要素を確実に取得
            let modal = document.getElementById('editModal');
            if (!modal) {
                console.error('修正モーダルが見つかりません。DOMを再確認します...');
                // DOMが完全に読み込まれていない可能性があるので、少し待ってから再試行
                setTimeout(() => {
                    modal = document.getElementById('editModal');
                    if (!modal) {
                        console.error('修正モーダルが見つかりません');
                        alert('修正モーダルが見つかりません。ページをリロードしてください。');
                        return;
                    }
                    openEditModalInternal(modal, receipt);
                }, 100);
                return;
            }
            
            openEditModalInternal(modal, receipt);
        };
        
        // 内部関数：モーダルを開く
        function openEditModalInternal(modal, receipt) {
            console.log('モーダル要素を確認:', modal);
            
            // モーダルの内容をリセット
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800" id="editModalTitle">項目を編集</h3>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2" id="editModalLabel">値</label>
                        <div id="editModalInput"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="closeEditModal()" class="btn btn-outline btn-sm">キャンセル</button>
                        <button onclick="saveEdit()" class="btn bg-slate-600 hover:bg-slate-700 text-white btn-sm">保存</button>
                    </div>
                </div>
            `;
            
            // モーダルを表示
            modal.style.display = 'flex';
            
            // 少し待ってから要素を取得
            setTimeout(() => {
                // モーダル内から直接要素を検索
                const title = modal.querySelector('#editModalTitle');
                const label = modal.querySelector('#editModalLabel');
                const input = modal.querySelector('#editModalInput');
                
                console.log('タイトル要素:', title);
                console.log('ラベル要素:', label);
                console.log('入力要素:', input);
                
                if (!title || !label || !input) {
                    console.error('モーダル要素が見つかりません');
                    console.log('モーダルのHTML:', modal.innerHTML);
                    alert('モーダル要素が見つかりません');
                    modal.style.display = 'none';
                    return;
                }
                
                openEditModalFinal(title, label, input, receipt);
            }, 100);
        }
        
        // 最終的なモーダル表示処理
        function openEditModalFinal(title, label, input, receipt) {
            console.log('最終的なモーダル表示処理を開始');
            console.log('受け取ったreceipt:', receipt);
            
            title.textContent = 'レシート情報を修正';
            label.textContent = '修正したい項目を選択してください';
            
            // データの取得（extracted_dataと直接プロパティの両方をチェック）
            const extractedData = receipt.extracted_data;
            const storeName = receipt.store?.name || extractedData?.storeName || '';
            const date = receipt.transaction?.date || receipt.date || extractedData?.date || '';
            const currency = receipt.transaction?.currency || receipt.currency || extractedData?.currency || '';
            const totalAmount = receipt.transaction?.amount || receipt.totalAmount || extractedData?.totalAmount || '';
            const location = receipt.store?.location || extractedData?.location || '';
            const category = receipt.category || extractedData?.category || '';
            
            console.log('モーダル用データ:', { storeName, date, currency, totalAmount, location, category });
            
            // 修正可能な項目のリストを表示
            const inputHTML = `
                <div class="space-y-3">
                    <button onclick="editField('storeNameInput', 'text', '${storeName}')" class="btn btn-outline w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        店舗名を修正: ${storeName || '未設定'}
                    </button>
                    
                    <button onclick="editField('dateInput', 'date', '${date}')" class="btn btn-outline w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        日付を修正: ${date || '未設定'}
                    </button>
                    
                    <button onclick="editField('amountInput', 'currency', '${currency}')" class="btn btn-outline w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                        </svg>
                        金額を修正: ${currency} ${totalAmount || '未設定'}
                    </button>
                    
                    <button onclick="editField('locationInput', 'text', '${location}')" class="btn btn-outline w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        場所を修正: ${location || '未設定'}
                    </button>
                    
                    <button onclick="editField('categorySelect', 'select', '${category}')" class="btn btn-outline w-full justify-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        カテゴリを修正: ${category || '未設定'}
                    </button>
                </div>
            `;
            
            input.innerHTML = inputHTML;
            document.body.style.overflow = 'hidden';
            
            console.log('修正モーダルを表示しました');
        }
        
        
        // 編集モーダルの開閉機能
        window.editField = function(fieldId, fieldType, currentValue) {
            console.log('editField関数が呼ばれました:', fieldId, fieldType, currentValue);
            
            currentEditField = fieldId;
            currentEditType = fieldType;
            currentEditValue = currentValue;
            
            const modal = document.getElementById('editModal');
            if (!modal) {
                console.error('モーダルが見つかりません');
                alert('モーダルが見つかりません');
                return;
            }
            
            // モーダル内から直接要素を検索
            const title = modal.querySelector('#editModalTitle');
            const label = modal.querySelector('#editModalLabel');
            const input = modal.querySelector('#editModalInput');
            
            if (!title || !label || !input) {
                console.error('モーダル要素が見つかりません');
                console.log('モーダルのHTML:', modal.innerHTML);
                alert('モーダル要素が見つかりません');
                return;
            }
            
            // フィールド名を取得
            const fieldNames = {
                'storeNameInput': '店舗名',
                'dateInput': '日付',
                'amountInput': '金額',
                'locationInput': '場所',
                'categorySelect': 'カテゴリ'
            };
            
            title.textContent = `${fieldNames[fieldId] || '項目'}を編集`;
            label.textContent = fieldNames[fieldId] || '値';
            
            // 入力フィールドを生成
            // ヘルパー関数を定義
            const formatDate = (dateString) => {
                try {
                    if (!dateString) return '';
                    
                    // 既にYYYY-MM-DD形式の場合はそのまま返す
                    if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                        return dateString;
                    }
                    
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        console.warn('無効な日付形式:', dateString);
                        return '';
                    }
                    return date.toISOString().split('T')[0];
                } catch (error) {
                    console.error('日付フォーマットエラー:', error, '入力値:', dateString);
                    return '';
                }
            };
            
            const getNestedValue = (obj, path) => {
                return path.split('.').reduce((current, key) => current?.[key], obj);
            };
            
            let inputHTML = '';
            switch (fieldType) {
                case 'text':
                    inputHTML = `<input type="text" id="editInput" value="${currentValue}" class="input input-bordered w-full">`;
                    break;
                case 'date':
                    inputHTML = `<input type="date" id="editInput" value="${formatDate(currentValue)}" class="input input-bordered w-full">`;
                    break;
                case 'currency':
                    const amount = getNestedValue(currentReceipts[currentIndex], 'transaction.amount') || currentReceipts[currentIndex]?.totalAmount || 0;
                    const currentJpyAmount = currentReceipts[currentIndex]?.jpyAmount || 0;
                    inputHTML = `
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">通貨</label>
                                <input type="text" id="editCurrency" value="${currentValue}" class="input input-bordered w-full" placeholder="JPY" onchange="updateJPYConversion()">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">金額</label>
                                <input type="number" id="editAmount" value="${amount}" class="input input-bordered w-full" step="0.01" onchange="updateJPYConversion()">
                            </div>
                            <div class="bg-blue-50 p-2 rounded">
                                <label class="block text-xs text-gray-600 mb-1">日本円換算</label>
                                <div id="jpyConversionDisplay" class="text-sm font-medium text-blue-800">¥ ${currentJpyAmount}</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'select':
                    const options = [
                        { value: 'food', label: '食費' },
                        { value: 'transport', label: '交通費' },
                        { value: 'shopping', label: 'お買い物' },
                        { value: 'entertainment', label: '娯楽' },
                        { value: 'other', label: 'その他' }
                    ];
                    const optionHTML = options.map(opt => 
                        `<option value="${opt.value}" ${currentValue === opt.value ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');
                    inputHTML = `<select id="editInput" class="select select-bordered w-full">${optionHTML}</select>`;
                    break;
                default:
                    inputHTML = `<input type="text" id="editInput" value="${currentValue}" class="input input-bordered w-full">`;
            }
            
            input.innerHTML = inputHTML;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        };
        
        window.closeEditModal = function() {
            const modal = document.getElementById('editModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentEditField = null;
            currentEditType = null;
            currentEditValue = null;
        };
        
        window.saveEdit = function() {
            console.log('saveEdit関数が呼ばれました');
            
            if (!currentEditField) {
                console.log('編集フィールドが設定されていません');
                alert('編集フィールドが設定されていません');
                return;
            }
            
            let newValue = '';
            if (currentEditType === 'currency') {
                const currency = document.getElementById('editCurrency');
                const amount = document.getElementById('editAmount');
                
                if (currency && amount) {
                    newValue = `${currency.value} ${amount.value}`;
                } else {
                    console.log('通貨または金額の入力要素が見つかりません');
                    alert('通貨または金額の入力要素が見つかりません');
                    return;
                }
            } else {
                const input = document.getElementById('editInput');
                
                if (input) {
                    newValue = input.value;
                } else {
                    console.log('入力要素が見つかりません');
                    alert('入力要素が見つかりません');
                    return;
                }
            }
            
            console.log('保存する値:', newValue);
            
            // レシートデータを更新
            if (currentReceipts[currentIndex]) {
                const receipt = currentReceipts[currentIndex];
                if (currentEditField === 'storeNameInput') {
                    receipt.store = receipt.store || {};
                    receipt.store.name = newValue;
                } else if (currentEditField === 'dateInput') {
                    receipt.transaction = receipt.transaction || {};
                    // 日付の検証とフォーマット
                    try {
                        const date = new Date(newValue);
                        if (isNaN(date.getTime())) {
                            throw new Error('無効な日付です');
                        }
                        receipt.transaction.date = newValue;
                        receipt.date = newValue; // 互換性のため
                    } catch (error) {
                        console.error('日付保存エラー:', error);
                        alert('日付の形式が正しくありません: ' + newValue);
                        return;
                    }
                } else if (currentEditField === 'amountInput') {
                    // 金額の修正処理
                    const currency = document.getElementById('editCurrency').value;
                    const amount = parseFloat(document.getElementById('editAmount').value) || 0;
                    
                    receipt.transaction = receipt.transaction || {};
                    receipt.transaction.currency = currency;
                    receipt.transaction.amount = amount;
                    receipt.totalAmount = amount;
                    receipt.currency = currency;
                    
                    // 日本円換算を計算
                    const exchangeRates = {
                        'JPY': 1,
                        'USD': 150,
                        'EUR': 160,
                        'GBP': 190,
                        'AUD': 100,
                        'CAD': 110,
                        'CHF': 170,
                        'CNY': 20,
                        'KRW': 0.11,
                        'SGD': 110,
                        'THB': 4.2,
                        'MYR': 32,
                        'IDR': 0.01,
                        'PHP': 2.7,
                        'VND': 0.006,
                        'INR': 1.8
                    };
                    
                    const jpyAmount = Math.round(amount * (exchangeRates[currency] || 1));
                    receipt.jpyAmount = jpyAmount;
                    
                    console.log('金額を更新:', { currency, amount, jpyAmount });
                } else if (currentEditField === 'locationInput') {
                    receipt.store = receipt.store || {};
                    receipt.store.location = newValue;
                } else if (currentEditField === 'categorySelect') {
                    receipt.category = newValue;
                }
                
                console.log('レシートデータを更新しました:', receipt);
                
                // localStorageに更新されたデータを保存
                localStorage.setItem('currentReceiptAnalysis', JSON.stringify(receipt));
                console.log('localStorageに更新されたデータを保存しました');
                
                // 表示を更新
                displayReceiptInfo(receipt);
                
                // 成功メッセージ
                alert('修正が完了しました！');
            }
            
            closeEditModal();
        };
        
        // リアルタイム日本円換算更新
        window.updateJPYConversion = function() {
            const currency = document.getElementById('editCurrency');
            const amount = document.getElementById('editAmount');
            const jpyDisplay = document.getElementById('jpyConversionDisplay');
            
            if (!currency || !amount || !jpyDisplay) return;
            
            const exchangeRates = {
                'JPY': 1,
                'USD': 150,
                'EUR': 160,
                'GBP': 190,
                'AUD': 100,
                'CAD': 110,
                'CHF': 170,
                'CNY': 20,
                'KRW': 0.11,
                'SGD': 110,
                'THB': 4.2,
                'MYR': 32,
                'IDR': 0.01,
                'PHP': 2.7,
                'VND': 0.006,
                'INR': 1.8
            };
            
            const currencyValue = currency.value.toUpperCase();
            const amountValue = parseFloat(amount.value) || 0;
            const jpyAmount = Math.round(amountValue * (exchangeRates[currencyValue] || 1));
            
            jpyDisplay.textContent = `¥ ${jpyAmount.toLocaleString()}`;
        };
        
        // ESCキーでモーダルを閉じる
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
            }
        });
        
        // ログイン画面に遷移
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };
        
        // ユーザー情報を表示
        function updateUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            if (!userInfoDiv) return;
            
            // localStorageから認証状態を確認
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userEmail = localStorage.getItem('userEmail');
            
            if (isLoggedIn && userEmail) {
                userInfoDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>${userEmail}</span>
                `;
            } else {
                userInfoDiv.innerHTML = `
                    <button onclick="goToLogin()" class="flex items-center hover:text-blue-200 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>未ログイン</span>
                    </button>
                `;
            }
        }

        // ページ読み込み時にレシートを読み込み
        document.addEventListener('DOMContentLoaded', function() {
            // ローディング表示を即座に表示
            showLoadingMessage();
            
            // Firebase関数の読み込みを待ってからレシートを読み込み
            let checkCount = 0;
            const maxChecks = 50; // 最大50回までチェック
            
            const checkFirebaseFunctions = () => {
                checkCount++;
                console.log(`Firebase関数チェック ${checkCount}/${maxChecks}`);
                
                if (firebaseFunctions && firebaseFunctions.saveReceiptFromJSON) {
                    console.log('Firebase関数が準備完了、localStorageからレシートを読み込みます');
                    loadReceiptFromLocalStorage();
                } else if (checkCount >= maxChecks) {
                    console.error('Firebase関数の読み込みがタイムアウトしました');
                    showErrorMessage('Firebase関数の読み込みに失敗しました。ページをリロードしてください。');
                } else {
                    console.log('Firebase関数の読み込み待機中...');
                    setTimeout(checkFirebaseFunctions, 200); // 200msに変更
                }
            };
            
            // 即座にチェック開始（遅延を削除）
            checkFirebaseFunctions();
            
            // localStorageから分析結果を読み込み
            loadReceiptFromLocalStorage();
        });
        
        // DOMContentLoadedイベントでも実行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoadedイベントが発生しました');
            // 少し遅延させてから実行
            setTimeout(loadReceiptFromLocalStorage, 100);
        });
        
        
        // レシート情報を表示
        function displayReceiptInfo(receipt) {
            console.log('displayReceiptInfo関数が呼び出されました');
            const receiptInfoDiv = document.getElementById('receiptInfo');
            console.log('receiptInfoDiv要素:', receiptInfoDiv);
            
            if (!receiptInfoDiv) {
                console.error('receiptInfoDiv要素が見つかりません');
                return;
            }
            
            const extractedData = receipt.extracted_data;
            console.log('抽出されたデータ:', extractedData);
            console.log('画像URL:', receipt.image_url);
            
            // 編集されたデータを優先して表示（extracted_dataと直接プロパティの両方をチェック）
            const storeName = receipt.store?.name || extractedData.storeName || 'Unknown Store';
            const date = receipt.transaction?.date || receipt.date || extractedData.date || 'Unknown Date';
            const currency = receipt.transaction?.currency || receipt.currency || extractedData.currency || '';
            const totalAmount = receipt.transaction?.amount || receipt.totalAmount || extractedData.totalAmount || '0';
            const jpyAmount = receipt.jpyAmount || extractedData.jpyAmount || 0;
            const location = receipt.store?.location || extractedData.location || 'Unknown Location';
            const category = receipt.category || extractedData.category || 'other';
            
            console.log('表示用データ:', { storeName, date, currency, totalAmount, jpyAmount, location, category });
            
            receiptInfoDiv.innerHTML = `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">店舗名:</span>
                    <span class="font-medium text-gray-800">${storeName}</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">日付:</span>
                    <span class="font-medium text-gray-800">${date}</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">金額:</span>
                    <span class="font-medium text-gray-800">${currency} ${totalAmount}</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">日本円換算:</span>
                    <span class="font-medium text-blue-600">¥ ${Math.round(jpyAmount)}</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">場所:</span>
                    <span class="font-medium text-gray-800">${location}</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">カテゴリ:</span>
                    <select class="select select-bordered select-xs border-gray-300 w-20 text-xs" id="categorySelect">
                        <option value="food" ${category === 'food' ? 'selected' : ''}>食費</option>
                        <option value="transport" ${category === 'transport' ? 'selected' : ''}>交通費</option>
                        <option value="shopping" ${category === 'shopping' ? 'selected' : ''}>お買い物</option>
                        <option value="entertainment" ${category === 'entertainment' ? 'selected' : ''}>娯楽</option>
                        <option value="accommodation" ${category === 'accommodation' ? 'selected' : ''}>宿泊費</option>
                        <option value="other" ${category === 'other' ? 'selected' : ''}>その他</option>
                    </select>
                </div>
            `;
        }
        
        // デフォルトのレシート情報を表示
        function displayDefaultReceiptInfo() {
            const receiptInfoDiv = document.getElementById('receiptInfo');
            if (!receiptInfoDiv) return;
            
            receiptInfoDiv.innerHTML = `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">店舗名:</span>
                    <span class="font-medium text-gray-800">RED ELEPHANT</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">内容:</span>
                    <span class="font-medium text-gray-800">カレーライス × 2</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">金額:</span>
                    <span class="font-medium text-gray-800">RM 15.90</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">日本円換算:</span>
                    <span class="font-medium text-blue-600">¥ 520</span>
                </div>
                
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">カテゴリ:</span>
                    <select class="select select-bordered select-xs border-gray-300 w-20 text-xs">
                        <option value="food" selected>食費</option>
                        <option value="transport">交通費</option>
                        <option value="shopping">お買い物</option>
                        <option value="entertainment">娯楽</option>
                        <option value="other">その他</option>
                    </select>
                </div>
            `;
        }
        
        // localStorageから分析結果を読み込み
        function loadReceiptFromLocalStorage(retryCount = 0) {
            console.log('localStorageから分析結果を読み込み中...');
            
            const analysisData = localStorage.getItem('currentReceiptAnalysis');
            if (!analysisData) {
                console.log('localStorageに分析結果がありません');
                showNoReceiptsMessage();
                return;
            }
            
            try {
                const receiptData = JSON.parse(analysisData);
                console.log('localStorageから読み込んだデータ:', receiptData);
                
                // 単一のレシートとして処理
                currentReceipts = [receiptData];
                currentIndex = 0;
                
                // ローディング表示はそのまま保持
                
                // DOM要素の存在確認（詳細デバッグ）
                console.log('DOM要素の存在確認中...');
                console.log('document.readyState:', document.readyState);
                console.log('document.body:', document.body);
                
                const receiptInfoDiv = document.getElementById('receiptInfo');
                console.log('receiptInfo要素:', receiptInfoDiv);
                
                if (!receiptInfoDiv) {
                    // すべての要素を確認
                    const allElements = document.querySelectorAll('*');
                    console.log('ページ内の全要素数:', allElements.length);
                    
                    // すべてのIDを持つ要素を確認
                    const allIds = document.querySelectorAll('[id]');
                    console.log('IDを持つ要素:', Array.from(allIds).map(el => el.id));
                    
                    const receiptContent = document.getElementById('receiptContent');
                    console.log('receiptContent要素:', receiptContent);
                    
                    if (receiptContent) {
                        console.log('receiptContentの子要素:', receiptContent.children);
                        console.log('receiptContentのHTML:', receiptContent.innerHTML);
                    }
                    
                    // 直接セレクターで確認
                    const receiptInfoDirect = document.querySelector('#receiptInfo');
                    console.log('直接セレクターでのreceiptInfo:', receiptInfoDirect);
                    
                    // receiptInfo要素が見つからない場合、動的に作成
                    console.log('receiptInfo要素が見つからないため、動的に作成します');
                    
                    // receiptContent要素を探す
                    const receiptContentElement = document.getElementById('receiptContent');
                    if (!receiptContentElement) {
                        console.error('receiptContent要素も見つかりません');
                        showErrorMessage('ページの構造に問題があります。ページを再読み込みしてください。');
                        return;
                    }
                    
                    // receiptContentの内容をクリアして、シンプルな構造で再作成
                    receiptContentElement.innerHTML = '';
                    
                    // レシート情報
                    const receiptInfoDiv = document.createElement('div');
                    receiptInfoDiv.id = 'receiptInfo';
                    receiptInfoDiv.className = 'space-y-3';
                    
                    const extractedData = receiptData.extracted_data;
                    receiptInfoDiv.innerHTML = `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">店舗名:</span>
                            <span class="font-medium text-gray-800">${extractedData.storeName || 'Unknown Store'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">日付:</span>
                            <span class="font-medium text-gray-800">${extractedData.date || 'Unknown Date'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">金額:</span>
                            <span class="font-medium text-gray-800">${extractedData.currency || ''} ${extractedData.totalAmount || '0'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">日本円換算:</span>
                            <span class="font-medium text-blue-600">¥ ${Math.round(extractedData.jpyAmount || 0)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">場所:</span>
                            <span class="font-medium text-gray-800">${extractedData.location || 'Unknown Location'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">カテゴリ:</span>
                            <select class="select select-bordered select-xs border-gray-300 w-20 text-xs" id="categorySelect">
                                <option value="food" ${extractedData.category === 'food' ? 'selected' : ''}>食費</option>
                                <option value="transport" ${extractedData.category === 'transport' ? 'selected' : ''}>交通費</option>
                                <option value="shopping" ${extractedData.category === 'shopping' ? 'selected' : ''}>お買い物</option>
                                <option value="entertainment" ${extractedData.category === 'entertainment' ? 'selected' : ''}>娯楽</option>
                                <option value="accommodation" ${extractedData.category === 'accommodation' ? 'selected' : ''}>宿泊費</option>
                                <option value="other" ${extractedData.category === 'other' ? 'selected' : ''}>その他</option>
                            </select>
                        </div>
                    `;
                    
                    // receiptContentに追加
                    receiptContentElement.appendChild(receiptInfoDiv);
                    console.log('receiptContentをクリアして、レシート情報のみで再作成しました');
                    
                    console.log('localStorageからの読み込み完了');
                    return;
                }
                
                // レシート情報を表示
                displayReceiptInfo(receiptData);
                
                console.log('localStorageからの読み込み完了');
            } catch (error) {
                console.error('localStorageデータの解析エラー:', error);
                showErrorMessage('分析結果の解析に失敗しました。');
            }
        }
        
        // デバッグ関数
        function debugLocalStorage() {
            console.log('=== localStorage デバッグ情報 ===');
            const analysisData = localStorage.getItem('currentReceiptAnalysis');
            console.log('currentReceiptAnalysis:', analysisData);
            
            if (analysisData) {
                try {
                    const parsed = JSON.parse(analysisData);
                    console.log('解析されたデータ:', parsed);
                    alert('localStorageにデータがあります。コンソールを確認してください。');
                } catch (error) {
                    console.error('JSON解析エラー:', error);
                    alert('JSON解析エラー: ' + error.message);
                }
            } else {
                console.log('localStorageにデータがありません');
                alert('localStorageにデータがありません');
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('currentReceiptAnalysis');
            console.log('localStorageをクリアしました');
            alert('localStorageをクリアしました');
            location.reload();
        }
        
        function setTestData() {
            const testData = {
                receipt_id: 'test_receipt_001',
                image_url: 'test_image_url',
                extracted_data: {
                    storeName: 'テスト店舗',
                    date: '2024-01-15',
                    currency: 'RM',
                    totalAmount: '25.50',
                    location: 'クアラルンプール',
                    category: 'food',
                    jpyAmount: 850
                },
                processed_at: new Date().toISOString(),
                confidence: 0.95
            };
            
            localStorage.setItem('currentReceiptAnalysis', JSON.stringify(testData));
            console.log('テストデータを設定しました:', testData);
            alert('テストデータを設定しました。手動読み込みボタンをクリックしてください。');
        }
        
        // テストデータ設定関数
        
        // DOMContentLoadedイベントでlocalStorageから読み込み
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoadedイベント発生、localStorageから分析結果を読み込みます');
            setTimeout(function() {
                console.log('setTimeoutで実行中...');
                loadReceiptFromLocalStorage();
            }, 100);
        });
    </script>
    
    <!-- DOMContentLoadedイベントで実行 -->
    <script>
        console.log('インラインスクリプト実行中...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('インラインスクリプトのDOMContentLoaded実行中...');
            setTimeout(function() {
                if (typeof loadReceiptFromLocalStorage === 'function') {
                    console.log('loadReceiptFromLocalStorage関数が見つかりました');
                    loadReceiptFromLocalStorage();
                } else {
                    console.log('loadReceiptFromLocalStorage関数が見つかりません。メインスクリプトで既に実行済みの可能性があります');
                    // 関数が見つからない場合は、既にメインスクリプトで実行済みの可能性がある
                    // エラーを出さずに処理を終了
                }
            }, 500);
        });
    </script>
</body>
</html>