<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·å¤–ãƒ¬ã‚·ãƒ¼ãƒˆç®¡ç†ãƒã‚¹ã‚¿ãƒ¼ - ã‚¹ãƒ†ãƒƒãƒ—3/3ï¼šã‚µãƒãƒªãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#3B82F6',
                        'custom-gray': '#6B7280'
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <!-- Navigation -->
    <script src="navigation.js"></script>
</head>
<body class="bg-base-100 min-h-screen">
    <div class="min-h-screen bg-gray-100">
        <div class="w-full bg-white min-h-screen">
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ï¼‰ -->
            
            <div class="px-3 py-4 sm:px-4 sm:py-6 pt-16 pb-16">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center mb-8">
                <h1 class="text-xl font-bold text-gray-800">ã‚µãƒãƒªãƒ¼æƒ…å ±</h1>
                <p class="text-sm text-gray-600 mt-3">ç™»éŒ²æ¸ˆã¿ã®ãƒ¬ã‚·ãƒ¼ãƒˆã®æ¦‚è¦ã‚’ç¢ºèªã§ãã¾ã™</p>
            </div>


            <!-- æœŸé–“è¨­å®š -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">ã‚°ãƒ©ãƒ•ã®å¯¾è±¡æœŸé–“</h3>
                    <div class="space-y-3">
                        <!-- ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ã‚«ã‚¹ã‚¿ãƒ æœŸé–“</label>
                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex gap-2">
                                    <input type="date" id="startDate" class="input input-bordered input-sm flex-1">
                                    <span class="text-gray-500 self-center text-sm">ã€œ</span>
                                    <input type="date" id="endDate" class="input input-bordered input-sm flex-1">
                                </div>
                                <button onclick="setCustomPeriod()" class="btn btn-sm bg-amber-600 hover:bg-amber-700 text-white w-full">
                                    é©ç”¨
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç¾åœ¨ã®æœŸé–“è¡¨ç¤º -->
                        <div class="text-sm text-gray-600">
                            <span id="currentPeriod">ç¾åœ¨ã®æœŸé–“: 1ãƒ¶æœˆ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚µãƒãƒªãƒ¼ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="p-4">
                    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤º -->
                    <div class="space-y-6">
                        <!-- æ—¥ä»˜åˆ¥æ¨ç§»ã‚°ãƒ©ãƒ• -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="h-48 bg-white rounded relative">
                                <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                                <div class="ml-8 h-full relative px-2 py-2">
                                    <!-- ã‚°ãƒ©ãƒ•ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                        
                       
                        
                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ -->
                        <div class="text-center">
                            <a href="registration_step1.html" class="btn btn-outline btn-sm">
                                æ–°ãŸãªãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebaseé–¢æ•°ã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        let firebaseFunctions;
        
        // Firebaseé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
        async function loadFirebaseFunctions() {
            try {
                const firebaseModule = await import('./firebase-config.js');
                firebaseFunctions = firebaseModule;
                console.log('Firebaseé–¢æ•°ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                updateUserInfo();
                
                // èªè¨¼çŠ¶æ…‹ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
                await waitForAuth();
            } catch (error) {
                console.error('Firebaseé–¢æ•°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // èªè¨¼çŠ¶æ…‹ã‚’å¾…ã¤é–¢æ•°
        async function waitForAuth() {
            return new Promise((resolve) => {
                const checkAuth = () => {
                    if (firebaseFunctions && firebaseFunctions.auth) {
                        const user = firebaseFunctions.auth.currentUser;
                        if (user) {
                            console.log('èªè¨¼çŠ¶æ…‹ç¢ºèªå®Œäº†:', user.email);
                            loadGraphData();
                            resolve();
                        } else {
                            // èªè¨¼çŠ¶æ…‹ãŒã¾ã ç¢ºå®šã—ã¦ã„ãªã„å ´åˆã€å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
                            setTimeout(checkAuth, 100);
                        }
                    } else {
                        // Firebaseé–¢æ•°ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã€å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
                        setTimeout(checkAuth, 100);
                    }
                };
                checkAuth();
            });
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };
        
        // å…¨ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºç”»é¢ã«é·ç§»
        window.viewAllReceipts = function() {
            window.location.href = 'all_receipts.html';
        };
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        function updateUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            if (!userInfoDiv) return;
            
            // localStorageã‹ã‚‰èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userEmail = localStorage.getItem('userEmail');
            
            if (isLoggedIn && userEmail) {
                userInfoDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>${userEmail}</span>
                `;
            } else {
                userInfoDiv.innerHTML = `
                    <button onclick="goToLogin()" class="flex items-center hover:text-blue-200 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>æœªãƒ­ã‚°ã‚¤ãƒ³</span>
                    </button>
                `;
            }
        }
        
        // æœŸé–“è¨­å®šã®å¤‰æ•°
        let currentPeriod = 'all';
        let startDate = null;
        let endDate = null;
        let allReceipts = []; // å…¨ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        
        // æœŸé–“è¨­å®šé–¢æ•°
        window.setPeriod = function(period) {
            currentPeriod = period;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            const periodButtons = document.querySelectorAll('.period-btn');
            if (periodButtons.length > 0) {
                periodButtons.forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                });
                const activeButton = document.querySelector(`[data-period="${period}"]`);
                if (activeButton) {
                    activeButton.classList.remove('btn-outline');
                    activeButton.classList.add('btn-primary');
                }
            }
            
            // æœŸé–“ã‚’è¨ˆç®—
            const today = new Date();
            switch(period) {
                case 'week':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    updatePeriodDisplay('1é€±é–“');
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    endDate = today;
                    updatePeriodDisplay('1ãƒ¶æœˆ');
                    break;
                case '3months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                    endDate = today;
                    updatePeriodDisplay('3ãƒ¶æœˆ');
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    endDate = today;
                    updatePeriodDisplay('1å¹´');
                    break;
                case 'all':
                    startDate = null;
                    endDate = null;
                    updatePeriodDisplay('ã™ã¹ã¦');
                    break;
            }
            
            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateGraph();
        };
        
        // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“è¨­å®š
        window.setCustomPeriod = function() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            if (!startInput.value || !endInput.value) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            startDate = new Date(startInput.value);
            endDate = new Date(endInput.value);
            
            if (startDate > endDate) {
                alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã«è¨­å®š
            currentPeriod = 'custom';
            
            console.log('ã‚«ã‚¹ã‚¿ãƒ æœŸé–“è¨­å®š:', {
                startDate: startInput.value,
                endDate: endInput.value,
                startDateObj: startDate,
                endDateObj: endDate,
                currentPeriod: currentPeriod
            });
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            
            const periodText = `${startInput.value} ã€œ ${endInput.value}`;
            updatePeriodDisplay(periodText);
            
            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateGraph();
        };
        
        // æœŸé–“è¡¨ç¤ºã‚’æ›´æ–°
        function updatePeriodDisplay(periodText) {
            const currentPeriodElement = document.getElementById('currentPeriod');
            if (currentPeriodElement) {
                currentPeriodElement.textContent = `ç¾åœ¨ã®æœŸé–“: ${periodText}`;
            } else {
                console.warn('currentPeriodè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        function updateGraph() {
            console.log('ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ä¸­...', { currentPeriod, startDate, endDate });
            
            // æ—¢ã«èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            if (allReceipts && allReceipts.length > 0) {
                const filteredReceipts = filterReceiptsByPeriod(allReceipts);
                updateGraphDisplay(filteredReceipts);
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å†èª­ã¿è¾¼ã¿
                loadGraphData();
            }
        }
        
        // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadGraphData() {
            try {
                if (!firebaseFunctions || !firebaseFunctions.getUserReceipts) {
                    console.error('getUserReceiptsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // DOMè¦ç´ ã®å­˜åœ¨ã‚’ç¢ºèª
                const currentPeriodElement = document.getElementById('currentPeriod');
                if (!currentPeriodElement) {
                    console.warn('currentPeriodè¦ç´ ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¾ã™ã€‚');
                    setTimeout(loadGraphData, 100);
                    return;
                }

                console.log('ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                
                // Firebaseã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå‰Šé™¤ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ãªã„ã‚‚ã®ã®ã¿ï¼‰
                const rawReceipts = await firebaseFunctions.getUserReceipts();
                
                // é‡è¤‡ã™ã‚‹IDã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‡¦ç†ï¼ˆæœ€æ–°ã®updatedAtã‚’æŒã¤ã‚‚ã®ã‚’å„ªå…ˆï¼‰
                const receiptMap = new Map();
                rawReceipts.forEach(receipt => {
                    const existingReceipt = receiptMap.get(receipt.id);
                    if (!existingReceipt || 
                        (receipt.updatedAt && existingReceipt.updatedAt && 
                         new Date(receipt.updatedAt) > new Date(existingReceipt.updatedAt))) {
                        receiptMap.set(receipt.id, receipt);
                    }
                });
                
                allReceipts = Array.from(receiptMap.values());
                
                console.log('é‡è¤‡é™¤å»å¾Œã®ãƒ¬ã‚·ãƒ¼ãƒˆæ•°:', allReceipts.length, 'ä»¶');
                
                // å…¨æœŸé–“ã®å ´åˆã¯ã€ãƒ¬ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹æœŸé–“ã‚’è‡ªå‹•è¨­å®š
                if (currentPeriod === 'all' && allReceipts.length > 0) {
                    setAllPeriodFromReceipts();
                } else if (currentPeriod === 'custom' && (!startDate || !endDate)) {
                    // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€startDate/endDateãŒæœªè¨­å®šã®å ´åˆã¯å…¨æœŸé–“ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    console.log('ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã®æ—¥ä»˜ãŒæœªè¨­å®šã®ãŸã‚ã€å…¨æœŸé–“ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                    currentPeriod = 'all';
                    setAllPeriodFromReceipts();
                }
                
                // æœŸé–“ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const filteredReceipts = filterReceiptsByPeriod(allReceipts);
                
                // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                updateGraphDisplay(filteredReceipts);
                
            } catch (error) {
                console.error('ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (error.message && error.message.includes('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“')) {
                    showAuthError();
                } else {
                    showDataError();
                }
            }
        }
        
        // èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        function showAuthError() {
            const graphContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3');
            if (!graphContainer) return;
            
            graphContainer.innerHTML = `
                <div class="flex items-center justify-center h-48">
                    <div class="text-center">
                        <div class="text-red-500 text-4xl mb-4">ğŸ”’</div>
                        <div class="text-red-600 font-medium mb-2">èªè¨¼ã‚¨ãƒ©ãƒ¼</div>
                        <div class="text-gray-600 text-sm mb-4">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>
                        <button onclick="goToLogin()" class="btn btn-primary btn-sm">
                            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
        function showDataError() {
            const graphContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3');
            if (!graphContainer) return;
            
            graphContainer.innerHTML = `
                <div class="flex items-center justify-center h-48">
                    <div class="text-center">
                        <div class="text-gray-400 text-4xl mb-4">ğŸ“Š</div>
                        <div class="text-gray-600 font-medium mb-2">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
                        <div class="text-gray-500 text-sm">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</div>
                    </div>
                </div>
            `;
        }
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…¨æœŸé–“ã‚’è‡ªå‹•è¨­å®š
        function setAllPeriodFromReceipts() {
            if (allReceipts.length === 0) return;
            
            const dates = allReceipts.map(receipt => {
                const dateStr = receipt.transaction?.date || receipt.date;
                return new Date(dateStr);
            }).filter(date => !isNaN(date.getTime()));
            
            if (dates.length > 0) {
                startDate = new Date(Math.min(...dates));
                endDate = new Date(Math.max(...dates));
                
                // æœŸé–“è¡¨ç¤ºã‚’æ›´æ–°
                const startStr = startDate.toISOString().split('T')[0];
                const endStr = endDate.toISOString().split('T')[0];
                updatePeriodDisplay(`${startStr} ã€œ ${endStr}`);
                
                console.log('å…¨æœŸé–“ã‚’è‡ªå‹•è¨­å®š:', startStr, 'ã€œ', endStr);
            }
        }
        
        // ã‚«ãƒ†ã‚´ãƒªåã‚’æ—¥æœ¬èªã«å¤‰æ›
        function translateCategory(category) {
            const categoryMap = {
                'food': 'é£Ÿè²»',
                'transportation': 'äº¤é€šè²»',
                'accommodation': 'å®¿æ³Šè²»',
                'entertainment': 'å¨¯æ¥½è²»',
                'shopping': 'è²·ã„ç‰©',
                'healthcare': 'åŒ»ç™‚è²»',
                'education': 'æ•™è‚²è²»',
                'other': 'ãã®ä»–'
            };
            
            return categoryMap[category.toLowerCase()] || category;
        }
        
        // æœŸé–“ã«åŸºã¥ã„ã¦ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterReceiptsByPeriod(receipts) {
            if (!startDate || !endDate) {
                return receipts;
            }
            
            return receipts.filter(receipt => {
                const receiptDate = new Date(receipt.transaction?.date || receipt.date);
                return receiptDate >= startDate && receiptDate <= endDate;
            });
        }
        
        // ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚’æ›´æ–°
        function updateGraphDisplay(receipts = []) {
            const graphContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3');
            if (!graphContainer) return;
            
            const periodText = currentPeriod === 'all' ? 'å…¨æœŸé–“' : 
                             currentPeriod === 'week' ? '1é€±é–“' :
                             currentPeriod === 'month' ? '1ãƒ¶æœˆ' :
                             currentPeriod === '3months' ? '3ãƒ¶æœˆ' :
                             currentPeriod === 'year' ? '1å¹´' : 'ã‚«ã‚¹ã‚¿ãƒ æœŸé–“';
            
            // ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰çµ±è¨ˆã‚’è¨ˆç®—
            const totalAmount = Math.round(receipts.reduce((sum, receipt) => {
                // jpyAmountãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆä¿®æ­£æ¸ˆã¿ãƒ¬ã‚·ãƒ¼ãƒˆï¼‰
                if (receipt.jpyAmount) {
                    return sum + receipt.jpyAmount;
                }
                
                // å¾“æ¥ã®è¨ˆç®—æ–¹æ³•ï¼ˆjpyAmountãŒãªã„å ´åˆï¼‰
                const amount = receipt.transaction?.amount || receipt.totalAmount || 0;
                const currency = receipt.transaction?.currency || receipt.currency || 'JPY';
                
                // JPYã«æ›ç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                if (currency === 'JPY') {
                    return sum + amount;
                } else if (currency === 'USD') {
                    return sum + (amount * 150); // ç°¡æ˜“æ›ç®—
                } else if (currency === 'EUR') {
                    return sum + (amount * 160); // ç°¡æ˜“æ›ç®—
                }
                return sum + amount;
            }, 0));
            
            const receiptCount = receipts.length;
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
            const categoryTotals = {};
            receipts.forEach(receipt => {
                let category = receipt.category || 'ãã®ä»–';
                // ã‚«ãƒ†ã‚´ãƒªåã‚’æ—¥æœ¬èªã«å¤‰æ›
                category = translateCategory(category);
                
                // jpyAmountãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆä¿®æ­£æ¸ˆã¿ãƒ¬ã‚·ãƒ¼ãƒˆï¼‰
                let jpyAmount;
                if (receipt.jpyAmount) {
                    jpyAmount = receipt.jpyAmount;
                } else {
                    // å¾“æ¥ã®è¨ˆç®—æ–¹æ³•ï¼ˆjpyAmountãŒãªã„å ´åˆï¼‰
                    const amount = receipt.transaction?.amount || receipt.totalAmount || 0;
                    const currency = receipt.transaction?.currency || receipt.currency || 'JPY';
                    
                    jpyAmount = amount;
                    if (currency === 'USD') {
                        jpyAmount = amount * 150;
                    } else if (currency === 'EUR') {
                        jpyAmount = amount * 160;
                    }
                }
                
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.round(jpyAmount);
            });
            
            // æ—¥åˆ¥é›†è¨ˆï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ç”¨ï¼‰
            const dailyTotals = {};
            receipts.forEach(receipt => {
                const dateStr = receipt.transaction?.date || receipt.date;
                
                // jpyAmountãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆä¿®æ­£æ¸ˆã¿ãƒ¬ã‚·ãƒ¼ãƒˆï¼‰
                let jpyAmount;
                if (receipt.jpyAmount) {
                    jpyAmount = receipt.jpyAmount;
                } else {
                    // å¾“æ¥ã®è¨ˆç®—æ–¹æ³•ï¼ˆjpyAmountãŒãªã„å ´åˆï¼‰
                    const amount = receipt.transaction?.amount || receipt.totalAmount || 0;
                    const currency = receipt.transaction?.currency || receipt.currency || 'JPY';
                    
                    jpyAmount = amount;
                    if (currency === 'USD') {
                        jpyAmount = amount * 150;
                    } else if (currency === 'EUR') {
                        jpyAmount = amount * 160;
                    }
                }
                
                dailyTotals[dateStr] = (dailyTotals[dateStr] || 0) + Math.round(jpyAmount);
            });
            
            // ã‚°ãƒ©ãƒ•HTMLã‚’ç”Ÿæˆ
            graphContainer.innerHTML = `
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 text-center">æ”¯å‡ºåˆ†æ</h4>
                    
                    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-gray-600 text-sm">ç·æ”¯å‡º</div>
                            <div class="font-bold text-lg text-blue-600">Â¥${totalAmount.toLocaleString()}</div>
                        </div>
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-gray-600 text-sm">ãƒ¬ã‚·ãƒ¼ãƒˆæ•°</div>
                            <div class="font-bold text-lg text-green-600">${receiptCount}ä»¶</div>
                        </div>
                    </div>
                    
                    <!-- æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆæ—¥åˆ¥æ”¯å‡ºï¼‰ -->
                    <div class="bg-white p-3 rounded border">
                        <h5 class="font-medium text-gray-700 mb-2 text-center">æ—¥åˆ¥æ”¯å‡ºæ¨ç§»</h5>
                        <div class="h-40 bg-gray-50 rounded pb-8">
                            ${generateLineChart(dailyTotals)}
                        </div>
                    </div>
                    
                    <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºä¸€è¦§ -->
                    <div class="bg-white p-3 rounded border">
                        <h5 class="font-medium text-gray-700 mb-2 text-center">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º</h5>
                        ${totalAmount === 0 || Object.keys(categoryTotals).length === 0 ? 
                            `<div class="flex items-center justify-center h-24">
                                <div class="text-center">
                                    <div class="text-gray-400 text-3xl mb-1">ğŸ“Š</div>
                                    <div class="text-gray-500 text-xs">ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ãªã—</div>
                                </div>
                            </div>` :
                            generateCategoryList(categoryTotals, totalAmount)
                        }
                    </div>
                    
                </div>
            `;
        }
        
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºä¸€è¦§ã‚’ç”Ÿæˆ
        function generateCategoryList(categoryTotals, totalAmount) {
            const categories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a); // é‡‘é¡é †ã§ã‚½ãƒ¼ãƒˆ
            
            return `
                <div class="space-y-2">
                    ${categories.map(([category, amount]) => {
                        const percentage = ((amount / totalAmount) * 100).toFixed(1);
                        return `
                            <div class="flex justify-between items-center py-2 px-3 bg-gray-50 rounded">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${category}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-gray-900">Â¥${amount.toLocaleString()}</div>
                                    <div class="text-xs text-gray-500">${percentage}%</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
        function generateLineChart(dailyTotals) {
            const dates = Object.keys(dailyTotals).sort();
            
            if (dates.length === 0) {
                return '<div class="text-gray-500 text-sm flex items-center justify-center h-full">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            }
            
            const maxAmount = Math.max(...Object.values(dailyTotals));
            const roundedMaxAmount = Math.round(maxAmount);
            
            // Yè»¸ã®ç›®ç››ã‚Šã‚’ç”Ÿæˆ
            const yAxisLabels = [];
            for (let i = 0; i <= 5; i++) {
                const value = Math.round((roundedMaxAmount / 5) * i);
                yAxisLabels.push(value);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®åº§æ¨™ã‚’è¨ˆç®—
            const points = dates.map((date, index) => {
                const amount = Math.round(dailyTotals[date]);
                // å·¦å³ã«10%ã®ä½™ç™½ã‚’è¿½åŠ 
                const x = 10 + (index / (dates.length - 1)) * 80; // 10-90%ã®ç¯„å›²
                // ä¸Šä¸‹ã«ä½™ç™½ã‚’è¿½åŠ ï¼ˆ0å††ã®ä½ç½®ã‚’85%ã«è¨­å®šï¼‰
                const y = 10 + (100 - (amount / maxAmount) * 75); // 10-85%ã®ç¯„å›²ï¼ˆYè»¸åè»¢ï¼‰
                return { x, y, amount, date };
            });
            
            // SVGãƒ‘ã‚¹ã‚’ç”Ÿæˆï¼ˆæ»‘ã‚‰ã‹ãªæŠ˜ã‚Œç·šï¼‰
            const pathData = points.map((point, index) => {
                if (index === 0) {
                    return `M ${point.x} ${point.y}`;
                } else {
                    const prevPoint = points[index - 1];
                    const cp1x = prevPoint.x + (point.x - prevPoint.x) * 0.3;
                    const cp1y = prevPoint.y;
                    const cp2x = prevPoint.x + (point.x - prevPoint.x) * 0.7;
                    const cp2y = point.y;
                    return `C ${cp1x} ${cp1y} ${cp2x} ${cp2y} ${point.x} ${point.y}`;
                }
            }).join(' ');
            
            return `
                <div class="flex h-full">
                    <!-- Yè»¸ -->
                    <div class="flex flex-col justify-between pr-2 text-xs text-gray-600">
                        ${yAxisLabels.reverse().map(value => 
                            `<div class="text-right">Â¥${value.toLocaleString()}</div>`
                        ).join('')}
                    </div>
                    
                    <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                    <div class="flex-1 relative px-2 py-2 border-l border-b border-gray-300">
                        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none" style="shape-rendering: geometricPrecision;">
                            <!-- ã‚°ãƒªãƒƒãƒ‰ç·š -->
                            ${yAxisLabels.map((_, index) => {
                                const y = 10 + (index / (yAxisLabels.length - 1)) * 75;
                                return `<line x1="10" y1="${y}" x2="90" y2="${y}" stroke="#e5e7eb" stroke-width="0.2"/>`;
                            }).join('')}
                            
                            <!-- æŠ˜ã‚Œç·š -->
                            <path d="${pathData}" 
                                  fill="none" 
                                  stroke="#3B82F6" 
                                  stroke-width="1.5" 
                                  stroke-linecap="round" 
                                  stroke-linejoin="round"
                                  style="filter: drop-shadow(0 1px 2px rgba(59, 130, 246, 0.3));"/>
                            
                            <!-- ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ -->
                            ${points.map(point => `
                                <circle cx="${point.x}" 
                                        cy="${point.y}" 
                                        r="2.5" 
                                        fill="#3B82F6" 
                                        stroke="white" 
                                        stroke-width="1.5"
                                        style="filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));"
                                        class="hover:r-4 transition-all cursor-pointer"
                                        title="${new Date(point.date).toLocaleDateString('ja-JP')}: Â¥${point.amount.toLocaleString()}"/>
                            `).join('')}
                        </svg>
                        
                        <!-- Xè»¸ãƒ©ãƒ™ãƒ« -->
                        <div class="absolute -bottom-6 left-0 right-0 flex justify-between px-2">
                            ${dates.map((date, index) => {
                                const dateObj = new Date(date);
                                const month = dateObj.getMonth() + 1;
                                const day = dateObj.getDate();
                                const dateLabel = `${month}/${day}`;
                                // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã«åˆã‚ã›ã¦ãƒ©ãƒ™ãƒ«ã‚’é…ç½®
                                const labelPosition = 10 + (index / (dates.length - 1)) * 80;
                                return `<div class="text-xs text-gray-500 transform -rotate-45 origin-left whitespace-nowrap absolute" style="left: ${labelPosition}%;">${dateLabel}</div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // å††ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        function generatePieChart(categoryTotals, totalAmount) {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            let currentAngle = 0;
            
            console.log('å††ã‚°ãƒ©ãƒ•ç”Ÿæˆ:', { categoryTotals, totalAmount });
            
            // è§’åº¦ã®åˆè¨ˆã‚’è¨ˆç®—
            const totalAngle = Object.values(categoryTotals).reduce((sum, amount) => {
                return sum + ((amount / totalAmount) * 360);
            }, 0);
            
            console.log('è§’åº¦ã®åˆè¨ˆ:', totalAngle.toFixed(2) + 'Â°');
            
            // è§’åº¦ã®æ­£è¦åŒ–ä¿‚æ•°ã‚’è¨ˆç®—ï¼ˆ360åº¦ã«èª¿æ•´ï¼‰
            const normalizeFactor = totalAngle > 0 ? 360 / totalAngle : 1;
            
            console.log('æ­£è¦åŒ–ä¿‚æ•°:', normalizeFactor.toFixed(4));
            
            return `<svg viewBox="0 0 128 128" class="w-full h-full">` +
                Object.entries(categoryTotals).map(([category, amount], index) => {
                    const percentage = (amount / totalAmount) * 100;
                    const angle = (percentage / 100) * 360 * normalizeFactor; // æ­£è¦åŒ–ã‚’é©ç”¨
                    const color = colors[index % colors.length];
                    
                    console.log(`ã‚«ãƒ†ã‚´ãƒª: ${category}, é‡‘é¡: ${amount}, å‰²åˆ: ${percentage.toFixed(2)}%, æ­£è¦åŒ–å¾Œè§’åº¦: ${angle.toFixed(2)}Â°`);
                    
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angle;
                    const pathData = generatePieSlice(64, 64, 50, startAngle, endAngle);
                    currentAngle += angle;
                    
                    return `<path d="${pathData}" fill="${color}" stroke="white" stroke-width="2"/>`;
                }).join('') + `</svg>`;
        }
        
        // å††ã‚°ãƒ©ãƒ•ã®ã‚¹ãƒ©ã‚¤ã‚¹ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
        function generatePieSlice(cx, cy, radius, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, radius, endAngle);
            const end = polarToCartesian(cx, cy, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            
            return [
                "M", cx, cy,
                "L", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                "Z"
            ].join(" ");
        }
        
        // æ¥µåº§æ¨™ã‹ã‚‰ç›´äº¤åº§æ¨™ã«å¤‰æ›
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }
        
        // å††ã‚°ãƒ©ãƒ•ã®å‡¡ä¾‹ã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        function generatePieChartLegend(categoryTotals) {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            
            return Object.entries(categoryTotals).map(([category, amount], index) => {
                const color = colors[index % colors.length];
                return `
                    <div class="flex items-center text-xs">
                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></div>
                        <span class="text-gray-700">${category}: Â¥${amount.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Firebaseé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', function() {
            loadFirebaseFunctions();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨æœŸé–“ã‚’è¨­å®š
            setPeriod('all');
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
            document.getElementById('startDate').value = oneMonthAgo;
            
            // è‡ªå‹•ã§ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿
            setTimeout(() => {
                loadGraphData();
            }, 1000);
        });
    </script>
</body>
</html>