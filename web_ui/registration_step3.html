<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海外レシート管理マスター - ステップ3/3：サマリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#3B82F6',
                        'custom-gray': '#6B7280'
                    }
                }
            }
        }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <!-- Navigation -->
    <script src="navigation.js"></script>
</head>
<body class="bg-base-100 min-h-screen">
    <div class="min-h-screen bg-gray-100">
        <div class="w-full bg-white min-h-screen">
            <!-- ナビゲーションヘッダー（動的に生成される） -->
            
            <div class="px-3 py-4 sm:px-4 sm:py-6 pt-20 pb-16">
            <!-- ヘッダー -->
            <div class="text-center mb-8">
                <h1 class="text-xl font-bold text-gray-800">サマリー情報</h1>
                <p class="text-sm text-gray-600 mt-3">登録済みのレシートの概要を確認できます</p>
            </div>


            <!-- 期間設定 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">グラフの対象期間</h3>
                    <div class="space-y-3">
                        <!-- カスタム期間 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">カスタム期間</label>
                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex gap-2">
                                    <input type="date" id="startDate" class="input input-bordered input-sm flex-1">
                                    <span class="text-gray-500 self-center text-sm">〜</span>
                                    <input type="date" id="endDate" class="input input-bordered input-sm flex-1">
                                </div>
                                <button onclick="setCustomPeriod()" class="btn btn-sm bg-amber-600 hover:bg-amber-700 text-white w-full px-[20%]">
                                    適用
                                </button>
                            </div>
                        </div>
                        
                        <!-- 現在の期間表示 -->
                        <div class="text-sm text-gray-600">
                            <span id="currentPeriod">現在の期間: 1ヶ月</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- サマリー -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                <div class="p-4">
                    <!-- グラフ表示 -->
                    <div class="space-y-6">
                        <!-- 日付別推移グラフ -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="h-48 bg-white rounded relative">
                                <!-- ローディング表示 -->
                                <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-10">
                                    <div class="text-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600 mx-auto mb-2"></div>
                                        <p class="text-sm text-gray-600">最新データ取得中...</p>
                                    </div>
                                </div>
                                <!-- グラフエリア -->
                                <div id="graphArea" class="ml-8 h-full relative px-2 py-2">
                                    <!-- グラフは動的に生成される -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- アクションリンク（グラフエリアの外） -->
            <div class="text-center mt-4 space-y-2">
                <div class="flex justify-center px-[20%]">
                    <a href="registration_step1.html" class="btn btn-outline btn-sm w-full">
                        新たなレシートを追加
                    </a>
                </div>
                <div class="flex justify-center px-[20%]">
                    <a href="all_receipts.html" class="btn btn-outline btn-sm w-full">
                        レシート一覧を確認
                    </a>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase関数を動的インポート
        let firebaseFunctions;
        
        // ローディング表示制御
        function showLoading() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'flex';
            }
        }
        
        function hideLoading() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Firebase関数を読み込み
        async function loadFirebaseFunctions() {
            try {
                // ローディング表示開始
                showLoading();
                
                const firebaseModule = await import('./firebase-config.js');
                firebaseFunctions = firebaseModule;
                console.log('Firebase関数の読み込みが完了しました');
                
                // 認証状態を待ってからチェック
                console.log('認証状態を待機中...');
                const isAuthenticated = await waitForAuth();
                
                if (isAuthenticated) {
                    console.log('認証済み、ページを継続');
                    // ユーザー情報を表示
                    updateUserInfo();
                    
                    // デフォルトで全期間を設定（Firebase関数読み込み後）
                    setPeriod('all');
                    
                    // グラフを読み込み
                    loadGraphData();
                } else {
                    console.log('未認証、認証チェックを実行');
                    // 5秒待ってから認証チェックを実行
                    setTimeout(() => {
                        console.log('認証チェックを実行中...');
                        if (!firebaseModule.checkPageAuth()) {
                            console.log('認証チェック失敗');
                            hideLoading();
                            return; // 認証失敗時はリダイレクトされる
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('Firebase関数の読み込みエラー:', error);
                hideLoading();
            }
        }
        
        // 認証状態を待つ関数
        async function waitForAuth() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 5秒間（100ms × 50回）
                
                const checkAuth = () => {
                    attempts++;
                    
                    if (firebaseFunctions && firebaseFunctions.auth) {
                        const user = firebaseFunctions.auth.currentUser;
                        console.log(`認証確認試行 ${attempts}/${maxAttempts}:`, user ? user.email : '未認証');
                        
                        if (user) {
                            console.log('認証確認完了:', user.email);
                            resolve(true);
                        } else if (attempts >= maxAttempts) {
                            console.log('認証確認タイムアウト: 未認証');
                            resolve(false);
                        } else {
                            // 認証状態がまだ確定していない場合、少し待って再試行
                            setTimeout(checkAuth, 100);
                        }
                    } else {
                        if (attempts >= maxAttempts) {
                            console.log('Firebase関数読み込みタイムアウト');
                            resolve(false);
                        } else {
                            // Firebase関数がまだ読み込まれていない場合、少し待って再試行
                            setTimeout(checkAuth, 100);
                        }
                    }
                };
                checkAuth();
            });
        }
        
        // ログイン画面に遷移
        window.goToLogin = function() {
            window.location.href = 'login.html';
        };
        
        // 全レシート表示画面に遷移
        window.viewAllReceipts = function() {
            window.location.href = 'all_receipts.html';
        };
        
        // ユーザー情報を表示
        function updateUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            if (!userInfoDiv) return;
            
            // localStorageから認証状態を確認
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userEmail = localStorage.getItem('userEmail');
            
            if (isLoggedIn && userEmail) {
                userInfoDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>${userEmail}</span>
                `;
            } else {
                userInfoDiv.innerHTML = `
                    <button onclick="goToLogin()" class="flex items-center hover:text-blue-200 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>未ログイン</span>
                    </button>
                `;
            }
        }
        
        // 期間設定の変数
        let currentPeriod = 'all';
        let startDate = null;
        let endDate = null;
        let allReceipts = []; // 全レシートデータを保存
        
        // 期間設定関数
        window.setPeriod = function(period) {
            currentPeriod = period;
            
            // ボタンのアクティブ状態を更新（ボタンが存在する場合のみ）
            const periodButtons = document.querySelectorAll('.period-btn');
            if (periodButtons.length > 0) {
                periodButtons.forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                });
                const activeButton = document.querySelector(`[data-period="${period}"]`);
                if (activeButton) {
                    activeButton.classList.remove('btn-outline');
                    activeButton.classList.add('btn-primary');
                }
            }
            
            // 期間を計算
            const today = new Date();
            switch(period) {
                case 'week':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = today;
                    updatePeriodDisplay('1週間');
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    endDate = today;
                    updatePeriodDisplay('1ヶ月');
                    break;
                case '3months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                    endDate = today;
                    updatePeriodDisplay('3ヶ月');
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    endDate = today;
                    updatePeriodDisplay('1年');
                    break;
                case 'all':
                    startDate = null;
                    endDate = null;
                    updatePeriodDisplay('すべて');
                    break;
            }
            
            // グラフを更新
            updateGraph();
        };
        
        // カスタム期間設定
        window.setCustomPeriod = function() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            if (!startInput.value || !endInput.value) {
                alert('開始日と終了日を選択してください');
                return;
            }
            
            startDate = new Date(startInput.value);
            endDate = new Date(endInput.value);
            
            if (startDate > endDate) {
                alert('開始日は終了日より前の日付を選択してください');
                return;
            }
            
            // カスタム期間に設定
            currentPeriod = 'custom';
            
            console.log('カスタム期間設定:', {
                startDate: startInput.value,
                endDate: endInput.value,
                startDateObj: startDate,
                endDateObj: endDate,
                currentPeriod: currentPeriod
            });
            
            // ボタンのアクティブ状態をリセット
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            
            const periodText = `${startInput.value} 〜 ${endInput.value}`;
            updatePeriodDisplay(periodText);
            
            // グラフを更新
            updateGraph();
        };
        
        // 期間表示を更新
        function updatePeriodDisplay(periodText) {
            const currentPeriodElement = document.getElementById('currentPeriod');
            if (currentPeriodElement) {
                currentPeriodElement.textContent = `現在の期間: ${periodText}`;
            } else {
                console.warn('currentPeriod要素が見つかりません');
            }
        }
        
        // グラフを更新
        function updateGraph() {
            console.log('グラフを更新中...', { currentPeriod, startDate, endDate });
            
            // 既に読み込まれたデータがある場合は、それを使用してグラフを更新
            if (allReceipts && allReceipts.length > 0) {
                const filteredReceipts = filterReceiptsByPeriod(allReceipts);
                updateGraphDisplay(filteredReceipts);
            } else {
                // データがない場合は再読み込み（ローディング表示開始）
                showLoading();
                loadGraphData();
            }
        }

        // グラフデータを読み込み
        async function loadGraphData() {
            try {
                if (!firebaseFunctions || !firebaseFunctions.getUserReceipts) {
                    console.error('getUserReceipts関数が見つかりません');
                    return;
                }

                // 認証を待機
                const isAuthenticated = await waitForAuth();
                if (!isAuthenticated) {
                    console.error('認証が必要です。ログインしてください。');
                    return;
                }

                // DOM要素の存在を確認
                const currentPeriodElement = document.getElementById('currentPeriod');
                if (!currentPeriodElement) {
                    console.warn('currentPeriod要素がまだ読み込まれていません。少し待ってから再試行します。');
                    setTimeout(loadGraphData, 100);
                    return;
                }

                console.log('グラフデータを読み込み中...');
                
                // Firebaseからレシートデータを取得（削除フラグが立っていないもののみ）
                const rawReceipts = await firebaseFunctions.getUserReceipts();
                
                // 重複するIDのレシートを処理（最新のupdatedAtを持つものを優先）
                const receiptMap = new Map();
                rawReceipts.forEach(receipt => {
                    const existingReceipt = receiptMap.get(receipt.id);
                    if (!existingReceipt || 
                        (receipt.updatedAt && existingReceipt.updatedAt && 
                         new Date(receipt.updatedAt) > new Date(existingReceipt.updatedAt))) {
                        receiptMap.set(receipt.id, receipt);
                    }
                });
                
                allReceipts = Array.from(receiptMap.values());
                
                console.log('重複除去後のレシート数:', allReceipts.length, '件');
                
                // 全期間の場合は、レシートが存在する期間を自動設定
                if (currentPeriod === 'all' && allReceipts.length > 0) {
                    setAllPeriodFromReceipts();
                } else if (currentPeriod === 'custom' && (!startDate || !endDate)) {
                    // カスタム期間が設定されているが、startDate/endDateが未設定の場合は全期間にフォールバック
                    console.log('カスタム期間の日付が未設定のため、全期間にフォールバック');
                    currentPeriod = 'all';
                    setAllPeriodFromReceipts();
                }
                
                // 期間に基づいてデータをフィルタリング
                const filteredReceipts = filterReceiptsByPeriod(allReceipts);
                
                // グラフを更新
                updateGraphDisplay(filteredReceipts);
                
                // ローディング表示を非表示
                hideLoading();
                
            } catch (error) {
                console.error('グラフデータの読み込みエラー:', error);
                
                // ローディング表示を非表示
                hideLoading();
                
                // 認証エラーの場合は適切なメッセージを表示
                if (error.message && error.message.includes('ログインしていません')) {
                    showAuthError();
                } else {
                    showDataError();
                }
            }
        }
        
        // 認証エラーを表示
        function showAuthError() {
            const graphContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3');
            if (!graphContainer) return;
            
            graphContainer.innerHTML = `
                <div class="flex items-center justify-center h-48">
                    <div class="text-center">
                        <div class="text-red-500 text-4xl mb-4">🔒</div>
                        <div class="text-red-600 font-medium mb-2">認証エラー</div>
                        <div class="text-gray-600 text-sm mb-4">ログインが必要です</div>
                        <button onclick="goToLogin()" class="btn btn-primary btn-sm">
                            ログイン画面へ
                        </button>
                    </div>
                </div>
            `;
        }
        
        // データエラーを表示
        function showDataError() {
            const graphContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3');
            if (!graphContainer) return;
            
            graphContainer.innerHTML = `
                <div class="flex items-center justify-center h-48">
                    <div class="text-center">
                        <div class="text-gray-400 text-4xl mb-4">📊</div>
                        <div class="text-gray-600 font-medium mb-2">データの読み込みに失敗しました</div>
                        <div class="text-gray-500 text-sm">ページを再読み込みしてください</div>
                    </div>
                </div>
            `;
        }
        
        // レシートデータから全期間を自動設定
        function setAllPeriodFromReceipts() {
            if (allReceipts.length === 0) return;
            
            const dates = allReceipts.map(receipt => {
                const dateStr = receipt.transaction?.date || receipt.date;
                return new Date(dateStr);
            }).filter(date => !isNaN(date.getTime()));
            
            if (dates.length > 0) {
                startDate = new Date(Math.min(...dates));
                endDate = new Date(Math.max(...dates));
                
                // 期間表示を更新
                const startStr = startDate.toISOString().split('T')[0];
                const endStr = endDate.toISOString().split('T')[0];
                updatePeriodDisplay(`${startStr} 〜 ${endStr}`);
                
                console.log('全期間を自動設定:', startStr, '〜', endStr);
            }
        }
        
        // カテゴリ名を日本語に変換
        function translateCategory(category) {
            const categoryMap = {
                'food': '食費',
                'transportation': '交通費',
                'accommodation': '宿泊費',
                'entertainment': '娯楽費',
                'shopping': '買い物',
                'healthcare': '医療費',
                'education': '教育費',
                'other': 'その他',
                '食費': '食費',
                '交通費': '交通費',
                '宿泊費': '宿泊費',
                '娯楽費': '娯楽費',
                '買い物': '買い物',
                '医療費': '医療費',
                '教育費': '教育費',
                'その他': 'その他'
            };
            
            return categoryMap[category.toLowerCase()] || category;
        }
        
        // 日本円換算金額を取得（Geminiが計算した値を使用）
        function getJpyAmount(receipt) {
            // Geminiが計算した日本円換算額を優先的に取得
            // 複数の場所から日本円換算額を取得（優先順位付き）
            const jpyAmount = receipt.transaction?.jpyAmount || 
                            receipt.extracted_data?.jpyAmount || 
                            receipt.extracted_data?.total_jpy || 
                            receipt.jpyAmount || 
                            0;
            
            const originalAmount = receipt.transaction?.amount || receipt.totalAmount || receipt.extracted_data?.totalAmount || 0;
            const currency = receipt.transaction?.currency || receipt.currency || receipt.extracted_data?.currency || 'JPY';
            
            
            // Geminiが計算した日本円換算額が存在する場合はそれを使用
            if (jpyAmount > 0) {
                return jpyAmount;
            }
            
            // 日本円換算額が0円または未設定の場合
            if (currency === 'JPY') {
                // 日本円の場合は元金額をそのまま使用
                return originalAmount;
            } else {
                // 外国通貨で日本円換算額が未設定の場合は、元金額をそのまま表示
                // （Geminiが換算していない場合は、手動で換算する必要がある）
                console.warn(`日本円換算額が未設定: ${currency} ${originalAmount}`);
                return originalAmount;
            }
        }
        
        // 期間に基づいてレシートをフィルタリング
        function filterReceiptsByPeriod(receipts) {
            if (!startDate || !endDate) {
                return receipts;
            }
            
            return receipts.filter(receipt => {
                const receiptDate = new Date(receipt.transaction?.date || receipt.date);
                return receiptDate >= startDate && receiptDate <= endDate;
            });
        }
        
        // グラフ表示を更新
        function updateGraphDisplay(receipts = []) {
            const graphContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3');
            if (!graphContainer) return;
            
            const periodText = currentPeriod === 'all' ? '全期間' : 
                             currentPeriod === 'week' ? '1週間' :
                             currentPeriod === 'month' ? '1ヶ月' :
                             currentPeriod === '3months' ? '3ヶ月' :
                             currentPeriod === 'year' ? '1年' : 'カスタム期間';
            
            // レシートデータから統計を計算（日本円換算値の合算）
            const totalAmount = Math.round(receipts.reduce((sum, receipt) => {
                const jpyAmount = getJpyAmount(receipt);
                return sum + jpyAmount;
            }, 0));
            
            const receiptCount = receipts.length;
            
            // カテゴリ別集計
            const categoryTotals = {};
            receipts.forEach(receipt => {
                let category = receipt.category || 'その他';
                // カテゴリ名を日本語に変換
                category = translateCategory(category);
                
                // 日本円換算金額を取得
                const jpyAmount = getJpyAmount(receipt);
                
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.round(jpyAmount);
            });
            
            // 日別集計
            const dailyTotals = {};
            receipts.forEach(receipt => {
                const dateStr = receipt.transaction?.date || receipt.date;
                
                // 日本円換算金額を取得
                const jpyAmount = getJpyAmount(receipt);
                
                if (dateStr) {
                    dailyTotals[dateStr] = (dailyTotals[dateStr] || 0) + Math.round(jpyAmount);
                }
            });
            
            // グラフHTMLを生成
            graphContainer.innerHTML = `
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-800 text-center"></h4>
                    
                    <!-- 統計サマリー -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-gray-600 text-sm">支出金額</div>
                            <div class="font-bold text-lg text-blue-600">¥${totalAmount.toLocaleString()}</div>
                        </div>
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-gray-600 text-sm">レシート件数</div>
                            <div class="font-bold text-lg text-green-600">${receiptCount}件</div>
                        </div>
                    </div>
                    
                    <!-- 日別支出一覧 -->
                    <div class="bg-white p-3 rounded border">
                        <h5 class="font-medium text-gray-700 mb-2 text-center">日別支出</h5>
                        ${Object.keys(dailyTotals).length === 0 ? 
                            '<div class="text-center py-4 text-gray-500">データなし</div>' :
                            Object.entries(dailyTotals)
                                .sort(([a], [b]) => new Date(a) - new Date(b))
                                .map(([date, amount]) => `
                                    <div class="flex justify-between items-center py-2 px-3 bg-gray-50 rounded mb-2">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800">
                                                ${new Date(date).toLocaleDateString('ja-JP', { 
                                                    year: 'numeric', 
                                                    month: '2-digit', 
                                                    day: '2-digit',
                                                    weekday: 'short'
                                                })}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-semibold text-gray-900">¥${Math.round(amount).toLocaleString()}</div>
                                        </div>
                                    </div>
                                `).join('')
                        }
                    </div>
                    
                    <!-- カテゴリ別支出一覧 -->
                    <div class="bg-white p-3 rounded border">
                        <h5 class="font-medium text-gray-700 mb-2 text-center">カテゴリ別支出</h5>
                        ${totalAmount === 0 || Object.keys(categoryTotals).length === 0 ? 
                            `<div class="flex items-center justify-center h-24">
                                <div class="text-center">
                                    <div class="text-gray-400 text-3xl mb-1">📊</div>
                                    <div class="text-gray-500 text-xs">カテゴリデータなし</div>
                                </div>
                            </div>` :
                            generateCategoryList(categoryTotals, totalAmount)
                        }
                    </div>
                    
                </div>
            `;
        }
        
        // カテゴリ別支出一覧を生成
        function generateCategoryList(categoryTotals, totalAmount) {
            const categories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a); // 金額順でソート
            
            return `
                <div class="space-y-2">
                    ${categories.map(([category, amount]) => {
                        const percentage = ((amount / totalAmount) * 100).toFixed(1);
                        return `
                            <div class="flex justify-between items-center py-2 px-3 bg-gray-50 rounded">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${category}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-gray-900">¥${amount.toLocaleString()}</div>
                                    <div class="text-xs text-gray-500">${percentage}%</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // 棒グラフを生成
        function generateBarChart(dailyTotals) {
            const dates = Object.keys(dailyTotals).sort();
            
            if (dates.length === 0) {
                return '<div class="text-gray-500 text-sm flex items-center justify-center h-full">データなし</div>';
            }
            
            const maxAmount = Math.max(...Object.values(dailyTotals));
            const roundedMaxAmount = Math.round(maxAmount);
            
            // Y軸の目盛りを生成（わかりやすい単位で区切り）
            const yAxisLabels = [];
            let stepSize;
            
            if (roundedMaxAmount <= 1000) {
                stepSize = 200; // 1000円以下は200円単位
            } else if (roundedMaxAmount <= 5000) {
                stepSize = 500; // 5000円以下は500円単位
            } else if (roundedMaxAmount <= 20000) {
                stepSize = 1000; // 20000円以下は1000円単位
            } else if (roundedMaxAmount <= 50000) {
                stepSize = 5000; // 50000円以下は5000円単位
            } else {
                stepSize = 10000; // 50000円以上は10000円単位
            }
            
            // 最大値を丸めて、適切な区切りで目盛りを生成
            const roundedMax = Math.ceil(roundedMaxAmount / stepSize) * stepSize;
            const steps = Math.min(6, Math.ceil(roundedMax / stepSize) + 1);
            
            for (let i = 0; i < steps; i++) {
                const value = i * stepSize;
                if (value <= roundedMax) {
                    yAxisLabels.push(value);
                }
            }
            
            // 棒グラフのバーを生成（横棒グラフ）
            const bars = dates.map((date, index) => {
                const amount = Math.round(dailyTotals[date]);
                const totalHeight = 75; // グラフエリアの総高さ
                const barHeight = totalHeight / dates.length; // 各バーの高さ
                const barWidth = (amount / roundedMax) * 80; // バーの幅（新しい最大値基準）
                const x = 10; // バーのX位置（左端から開始）
                const y = 10 + (index * barHeight); // バーのY位置（余白なし）
                const barHeightPx = barHeight * 0.2; // 実際のバー高さ（20%に縮小して間隔を最大限に広げる）
                const barY = y + (barHeight * 0.4); // バーの実際のY位置（中央に配置）
                
                return { x, y: barY, barWidth, barHeight: barHeightPx, amount, date, originalY: y, barHeight: barHeight };
            });
            
            return `
                <div class="flex h-full">
                    <!-- Y軸（日付） -->
                    <div class="relative pr-2 text-xs text-gray-600" style="height: 100%;">
                        ${dates.map((date, index) => {
                            const totalHeight = 75; // グラフエリアの総高さ
                            const barHeight = totalHeight / dates.length; // 各バーの高さ
                            const yPosition = 10 + (index * barHeight) + (barHeight * 0.5); // バーの中央位置
                            return `<div class="text-left absolute" style="top: ${yPosition}%; transform: translateY(-50%);">${new Date(date).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })}</div>`;
                        }).join('')}
                    </div>
                    
                    <!-- グラフエリア -->
                    <div class="flex-1 relative px-2 py-2 border-l border-b border-gray-300">
                        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none" style="shape-rendering: geometricPrecision;">
                            <!-- グリッド線（縦線） -->
                            ${yAxisLabels.map((_, index) => {
                                const x = 10 + (index / (yAxisLabels.length - 1)) * 80;
                                return `<line x1="${x}" y1="10" x2="${x}" y2="85" stroke="#e5e7eb" stroke-width="0.2"/>`;
                            }).join('')}
                            
                            <!-- 棒グラフ -->
                            ${bars.map(bar => `
                                <rect x="${bar.x}" 
                                      y="${bar.y}" 
                                      width="${bar.barWidth}" 
                                      height="${bar.barHeight}" 
                                      fill="#3B82F6" 
                                      opacity="0.8"
                                      style="filter: drop-shadow(0 1px 2px rgba(59, 130, 246, 0.3));"
                                      title="${new Date(bar.date).toLocaleDateString('ja-JP')}: ¥${bar.amount.toLocaleString()}"/>
                            `).join('')}
                        </svg>
                        
                        <!-- X軸ラベル（金額） -->
                        <div class="absolute -bottom-6 left-0 right-0 flex justify-between px-2">
                            ${yAxisLabels.map((value, index) => {
                                // 金額ラベルの位置に合わせて配置
                                const labelPosition = 10 + (index / (yAxisLabels.length - 1)) * 80;
                                return `<div class="text-xs text-gray-500 transform -rotate-45 origin-left whitespace-nowrap absolute" style="left: ${labelPosition}%;">¥${value.toLocaleString()}</div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 円グラフを生成（データがある場合のみ）
        function generatePieChart(categoryTotals, totalAmount) {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            let currentAngle = 0;
            
            console.log('円グラフ生成:', { categoryTotals, totalAmount });
            
            // 角度の合計を計算
            const totalAngle = Object.values(categoryTotals).reduce((sum, amount) => {
                return sum + ((amount / totalAmount) * 360);
            }, 0);
            
            console.log('角度の合計:', totalAngle.toFixed(2) + '°');
            
            // 角度の正規化係数を計算（360度に調整）
            const normalizeFactor = totalAngle > 0 ? 360 / totalAngle : 1;
            
            console.log('正規化係数:', normalizeFactor.toFixed(4));
            
            return `<svg viewBox="0 0 128 128" class="w-full h-full">` +
                Object.entries(categoryTotals).map(([category, amount], index) => {
                    const percentage = (amount / totalAmount) * 100;
                    const angle = (percentage / 100) * 360 * normalizeFactor; // 正規化を適用
                    const color = colors[index % colors.length];
                    
                    console.log(`カテゴリ: ${category}, 金額: ${amount}, 割合: ${percentage.toFixed(2)}%, 正規化後角度: ${angle.toFixed(2)}°`);
                    
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angle;
                    const pathData = generatePieSlice(64, 64, 50, startAngle, endAngle);
                    currentAngle += angle;
                    
                    return `<path d="${pathData}" fill="${color}" stroke="white" stroke-width="2"/>`;
                }).join('') + `</svg>`;
        }
        
        // 円グラフのスライスパスを生成
        function generatePieSlice(cx, cy, radius, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, radius, endAngle);
            const end = polarToCartesian(cx, cy, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            
            return [
                "M", cx, cy,
                "L", start.x, start.y,
                "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                "Z"
            ].join(" ");
        }
        
        // 極座標から直交座標に変換
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }
        
        // 円グラフの凡例を生成（データがある場合のみ）
        function generatePieChartLegend(categoryTotals) {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            
            return Object.entries(categoryTotals).map(([category, amount], index) => {
                const color = colors[index % colors.length];
                return `
                    <div class="flex items-center text-xs">
                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></div>
                        <span class="text-gray-700">${category}: ¥${amount.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
        }
        
        // ページ読み込み時にFirebase関数を読み込み
        document.addEventListener('DOMContentLoaded', function() {
            // 今日の日付をデフォルトで設定
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
            document.getElementById('startDate').value = oneMonthAgo;
            
            // Firebase関数を読み込み（ローディング表示も含む）
            loadFirebaseFunctions();
        });
    </script>
</body>
</html>